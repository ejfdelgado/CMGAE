var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var hayValor = function hayValor(valor) {
	return valor != undefined && valor != null && (!(typeof valor == 'string') || valor.trim().length > 0);
};

var esFuncion = function esFuncion(algo) {
	return typeof algo == 'function';
};

var esNumero = function esNumero(dato) {
	return typeof dato == 'number' || /^\d+$/.test(dato);
};

var esBoolean = function esBoolean(variable) {
	return typeof variable === "boolean";
};

var esObjeto = function esObjeto(value) {
	return (typeof value === 'undefined' ? 'undefined' : _typeof(value)) == 'object' && value !== null;
};

var esLista = function esLista(value) {
	return hayValor(value) && value instanceof Array;
};

var estaEnLista = function estaEnLista(valor, lista) {
	if (!esLista(lista)) {
		return false;
	}
	return lista.indexOf(valor) >= 0;
};

var copiarJSON = function copiarJSON(dato) {
	if (typeof dato == 'undefined') {
		return null;
	}
	return JSON.parse(JSON.stringify(dato));
};

var esMultilenguaje = function esMultilenguaje(entrada) {
	return (/^(\S)+(\.\S+)+$/gim.test(entrada)
	);
};

function darNumeroAleatorio(min, max) {
	return Math.floor(Math.random() * (max - min + 1)) + min;
};

function decimalAHex(d, padding) {
	var hex = Number(d).toString(16);
	padding = typeof padding === "undefined" || padding === null ? padding = 2 : padding;

	while (hex.length < padding) {
		hex = "0" + hex;
	}
	return hex;
};

var darHtmlCompleto = function darHtmlCompleto(elem) {
	return $('<div>').append(elem.clone()).html();
};

var darHtmlSeguro = function darHtmlSeguro(texto) {
	return $('<div>').html(texto).html();
};

var deHtmlDarSoloTexto = function deHtmlDarSoloTexto(texto) {
	return $('<div>').html(texto).text();
};

var darColorAleatorio = function darColorAleatorio(min, max) {
	if (!esNumero(min)) {
		min = 0;
	}
	if (!esNumero(max)) {
		max = 255;
	}
	if (min < 0) {
		min = 0;
	}
	if (max > 255) {
		max = 255;
	}
	var color = '#';
	for (var i = 0; i < 3; i++) {
		color += decimalAHex(darNumeroAleatorio(min, max));
	}
	return color;
};

var quitarUltimoSlash = function quitarUltimoSlash(rutaDestino) {
	rutaDestino = rutaDestino.trim();
	if (rutaDestino.endsWith('/')) {
		rutaDestino = rutaDestino.substring(0, rutaDestino.length - 1);
	}
	return rutaDestino;
};

var leerObj = function leerObj(obj, nombres, predef, evitarInvocar) {
	if (!hayValor(nombres) || !esObjeto(obj)) {
		return predef;
	}
	var partes = nombres.split('.');
	var objetoActual = obj;
	for (var i = 0; i < partes.length; i++) {
		var llave = partes[i];
		if (esNumero(llave) && esLista(objetoActual)) {
			llave = parseInt(llave);
		}
		objetoActual = objetoActual[llave];
		if (i != partes.length - 1 && !esObjeto(objetoActual)) {
			return predef;
		}
	}
	if (!hayValor(objetoActual)) {
		return predef;
	}
	if (evitarInvocar !== true && esFuncion(objetoActual)) {
		return objetoActual();
	}
	return objetoActual;
};

var asignarObj = function asignarObj(raiz, nombres, valor) {
	var partes = nombres.split('.');
	var objetoActual = raiz;
	for (var i = 0; i < partes.length; i++) {
		var llave = partes[i];
		if (esNumero(llave)) {
			llave = parseInt(llave);
		}
		if (esObjeto(objetoActual)) {
			if (i == partes.length - 1) {
				if (esLista(objetoActual[llave]) && esLista(valor) && objetoActual[llave] !== valor) {
					objetoActual[llave].splice(0, objetoActual[llave].length);
					$.each(valor, function (i, eee) {
						objetoActual[llave].push(eee);
					});
				} else {
					objetoActual[llave] = valor;
				}
			} else {
				if (Object.keys(objetoActual).indexOf('' + llave) < 0 || objetoActual[llave] == null) {
					if (esNumero(partes[i + 1])) {
						objetoActual[llave] = [];
					} else {
						objetoActual[llave] = {};
					}
				}
				objetoActual = objetoActual[llave];
			}
		}
	}
};

var darRutasObjeto = function darRutasObjeto(objOr, filtroObjetoAgregar) {
	var ans = [];
	var funcionRecursiva = function funcionRecursiva(obj, rutaActual) {
		if (esObjeto(obj)) {
			$.each(obj, function (llave, valor) {
				var llaveSiguiente = null;
				if (rutaActual === null) {
					llaveSiguiente = llave;
				} else {
					llaveSiguiente = rutaActual + '.' + llave;
				}
				if (esFuncion(filtroObjetoAgregar) && filtroObjetoAgregar(valor)) {
					ans.push(llaveSiguiente);
				}
				funcionRecursiva(valor, llaveSiguiente);
			});
		} else {
			if (rutaActual !== null) {
				if (esFuncion(filtroObjetoAgregar)) {
					if (filtroObjetoAgregar(obj)) {
						ans.push(rutaActual);
					}
				} else {
					ans.push(rutaActual);
				}
			}
		}
	};

	funcionRecursiva(objOr, null);
	return ans;
};

var predefinir = function predefinir(objeto, ejemplo) {
	var llaves = darRutasObjeto(ejemplo);
	for (var i = 0; i < llaves.length; i++) {
		var llave = llaves[i];
		if (!hayValor(leerObj(objeto, llave, null, true))) {
			var nuevo = leerObj(ejemplo, llave, null, true);
			asignarObj(objeto, llave, nuevo);
		}
	}
	return objeto;
};

/*
Función que facilita la configuración de listas de datos con Midgard
La configuración de listas es algo como:
{
	'Caracteristica': {
		ejemplo: '#CaracteristicaEjemplo',
		campos: [
		         {nombre:'imagen', tipo:'Text'},
		         {nombre:'titulo', tipo:'TextSimple'},
		         {nombre:'contenido', tipo:'nuevo'},
		],
		listas: [{nombre:'lista1'}],
	}
}
 */
var configurarListasEditor = function configurarListasEditor(vie, configuracionListas) {
	vie.use(new vie.RdfaService());

	for (var tipoNombre in configuracionListas) {
		var tipoNombreRel = tipoNombre + 'Rel';
		var unTipo = configuracionListas[tipoNombre];
		var confCampos = [];
		for (var i = 0; i < unTipo.campos.length; i++) {
			var unCampo = unTipo.campos[i];
			confCampos.push({ 'id': unCampo.nombre, 'range': unCampo.tipo, 'min': 0, 'max': 1 });
		}
		vie.types.add(tipoNombre, confCampos);
		for (var j = 0; j < unTipo.listas.length; j++) {
			var elem = unTipo.listas[j];
			vie.types.add(elem.nombre, [{ id: tipoNombreRel, range: tipoNombre, min: 0, max: -1 }]);
		}
		vie.service('rdfa').setTemplate(tipoNombre, tipoNombreRel, jQuery(unTipo.ejemplo).html());
	}
};

var tieneAtributo = function tieneAtributo(elem, name) {
	var attr = elem.attr(name);
	return (typeof attr === 'undefined' ? 'undefined' : _typeof(attr)) !== (typeof undefined === 'undefined' ? 'undefined' : _typeof(undefined)) && attr !== false;
};

var activarConteoRegresivo = function activarConteoRegresivo() {
	//Countdown
	//<script src="/assets/js/comun/jquery.countdown.min.js"></script>
	//<div dateProperty="regresivo" data-value="{% buscar leng dicci tipo nodo 'regresivo' '1480809600' %}"><h1 class="mycountdown" data-format="yyyy/MM/dd" data-count-format="%D d&iacute;as %H:%M:%S"></h1></div>
	$('.mycountdown').each(function (i, obj) {
		var self = $(obj);
		var inicio = self.text();
		var formato = self.attr('data-count-format');
		self.countdown(inicio, function (event) {
			$(this).text(event.strftime(formato));
		});
	});
};

var jsonToHtml = function jsonToHtml(val) {
	return JSON.stringify(val, null, 4).replace('\n', '<br/>');
};

var copiarEnPortapapeles = function copiarEnPortapapeles(texto) {
	var aux = document.createElement("input");
	aux.setAttribute("value", texto);
	document.body.appendChild(aux);
	aux.select();
	document.execCommand("copy");
	document.body.removeChild(aux);
};

var darParametrosUrl = function darParametrosUrl(str) {
	if (!hayValor(str)) {
		str = location.search;
	}
	var regex = /([^&=?]+)=([^&=?]+)/ig;
	var result;
	var res = {};
	while (result = regex.exec(str)) {
		if (!esLista(res[result[1]])) {
			res[result[1]] = [];
		}
		res[result[1]].push(result[2]);
	}
	return res;
};

var urlContieneExtension = function urlContieneExtension(url, tipos) {
	url = url.toLowerCase();
	for (var i = 0; i < tipos.length; i++) {
		if (url.indexOf('.' + tipos[i]) >= 0) {
			return true;
		}
	}
	return false;
};

var eliminarPrefijo = function eliminarPrefijo(texto, prefijo) {
	if (!hayValor(texto)) {
		return '';
	}
	if (!hayValor(prefijo)) {
		return texto;
	}
	if (texto.startsWith(prefijo)) {
		return texto.substring(prefijo.length, texto.length);
	}
};

/**
*
*  MD5 (Message-Digest Algorithm)
*  http://www.webtoolkit.info/
*
**/
/**
*
*  MD5 (Message-Digest Algorithm)
*  http://www.webtoolkit.info/
*
**/
var MD5 = function MD5(string) {
	function RotateLeft(lValue, iShiftBits) {
		return lValue << iShiftBits | lValue >>> 32 - iShiftBits;
	}
	function AddUnsigned(lX, lY) {
		var lX4, lY4, lX8, lY8, lResult;
		lX8 = lX & 0x80000000;
		lY8 = lY & 0x80000000;
		lX4 = lX & 0x40000000;
		lY4 = lY & 0x40000000;
		lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
		if (lX4 & lY4) {
			return lResult ^ 0x80000000 ^ lX8 ^ lY8;
		}
		if (lX4 | lY4) {
			if (lResult & 0x40000000) {
				return lResult ^ 0xC0000000 ^ lX8 ^ lY8;
			} else {
				return lResult ^ 0x40000000 ^ lX8 ^ lY8;
			}
		} else {
			return lResult ^ lX8 ^ lY8;
		}
	}
	function F(x, y, z) {
		return x & y | ~x & z;
	}
	function G(x, y, z) {
		return x & z | y & ~z;
	}
	function H(x, y, z) {
		return x ^ y ^ z;
	}
	function I(x, y, z) {
		return y ^ (x | ~z);
	}
	function FF(a, b, c, d, x, s, ac) {
		a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
		return AddUnsigned(RotateLeft(a, s), b);
	};
	function GG(a, b, c, d, x, s, ac) {
		a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
		return AddUnsigned(RotateLeft(a, s), b);
	};
	function HH(a, b, c, d, x, s, ac) {
		a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
		return AddUnsigned(RotateLeft(a, s), b);
	};
	function II(a, b, c, d, x, s, ac) {
		a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
		return AddUnsigned(RotateLeft(a, s), b);
	};
	function ConvertToWordArray(string) {
		var lWordCount;
		var lMessageLength = string.length;
		var lNumberOfWords_temp1 = lMessageLength + 8;
		var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - lNumberOfWords_temp1 % 64) / 64;
		var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
		var lWordArray = Array(lNumberOfWords - 1);
		var lBytePosition = 0;
		var lByteCount = 0;
		while (lByteCount < lMessageLength) {
			lWordCount = (lByteCount - lByteCount % 4) / 4;
			lBytePosition = lByteCount % 4 * 8;
			lWordArray[lWordCount] = lWordArray[lWordCount] | string.charCodeAt(lByteCount) << lBytePosition;
			lByteCount++;
		}
		lWordCount = (lByteCount - lByteCount % 4) / 4;
		lBytePosition = lByteCount % 4 * 8;
		lWordArray[lWordCount] = lWordArray[lWordCount] | 0x80 << lBytePosition;
		lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
		lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
		return lWordArray;
	};
	function WordToHex(lValue) {
		var WordToHexValue = "",
		    WordToHexValue_temp = "",
		    lByte,
		    lCount;
		for (lCount = 0; lCount <= 3; lCount++) {
			lByte = lValue >>> lCount * 8 & 255;
			WordToHexValue_temp = "0" + lByte.toString(16);
			WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
		}
		return WordToHexValue;
	};
	function Utf8Encode(string) {
		string = string.replace(/\r\n/g, "\n");
		var utftext = "";
		for (var n = 0; n < string.length; n++) {
			var c = string.charCodeAt(n);
			if (c < 128) {
				utftext += String.fromCharCode(c);
			} else if (c > 127 && c < 2048) {
				utftext += String.fromCharCode(c >> 6 | 192);
				utftext += String.fromCharCode(c & 63 | 128);
			} else {
				utftext += String.fromCharCode(c >> 12 | 224);
				utftext += String.fromCharCode(c >> 6 & 63 | 128);
				utftext += String.fromCharCode(c & 63 | 128);
			}
		}
		return utftext;
	};
	var x = Array();
	var k, AA, BB, CC, DD, a, b, c, d;
	var S11 = 7,
	    S12 = 12,
	    S13 = 17,
	    S14 = 22;
	var S21 = 5,
	    S22 = 9,
	    S23 = 14,
	    S24 = 20;
	var S31 = 4,
	    S32 = 11,
	    S33 = 16,
	    S34 = 23;
	var S41 = 6,
	    S42 = 10,
	    S43 = 15,
	    S44 = 21;
	string = Utf8Encode(string);
	x = ConvertToWordArray(string);
	a = 0x67452301;b = 0xEFCDAB89;c = 0x98BADCFE;d = 0x10325476;
	for (k = 0; k < x.length; k += 16) {
		AA = a;BB = b;CC = c;DD = d;
		a = FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
		d = FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
		c = FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
		b = FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
		a = FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
		d = FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
		c = FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
		b = FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
		a = FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
		d = FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
		c = FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
		b = FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
		a = FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
		d = FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
		c = FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
		b = FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
		a = GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
		d = GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
		c = GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
		b = GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
		a = GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
		d = GG(d, a, b, c, x[k + 10], S22, 0x2441453);
		c = GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
		b = GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
		a = GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
		d = GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
		c = GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
		b = GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
		a = GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
		d = GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
		c = GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
		b = GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
		a = HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
		d = HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
		c = HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
		b = HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
		a = HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
		d = HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
		c = HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
		b = HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
		a = HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
		d = HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
		c = HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
		b = HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
		a = HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
		d = HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
		c = HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
		b = HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
		a = II(a, b, c, d, x[k + 0], S41, 0xF4292244);
		d = II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
		c = II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
		b = II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
		a = II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
		d = II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
		c = II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
		b = II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
		a = II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
		d = II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
		c = II(c, d, a, b, x[k + 6], S43, 0xA3014314);
		b = II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
		a = II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
		d = II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
		c = II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
		b = II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
		a = AddUnsigned(a, AA);
		b = AddUnsigned(b, BB);
		c = AddUnsigned(c, CC);
		d = AddUnsigned(d, DD);
	}
	var temp = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);
	return temp.toLowerCase();
};

var moduloSonido = function moduloSonido(url) {
	var audioElement = document.createElement('audio');
	audioElement.setAttribute('src', url);
	var diferido = $.Deferred();

	audioElement.addEventListener("canplay", function () {
		diferido.resolve();
	});

	var play = function play() {
		$.when(diferido).then(function () {
			audioElement.play();
		});
	};
	var stop = function stop() {
		$.when(diferido).then(function () {
			audioElement.pause();
			audioElement.currentTime = 0;
		});
	};
	return {
		'play': play,
		'stop': stop
	};
};

//TODO homologar con waitOn y waitOff
if (!hayValor(moduloActividad)) {
	var moduloActividad = function () {
		var pendientes = 0;
		var actividadOn = function actividadOn(mensaje) {
			if (!hayValor(mensaje)) {
				mensaje = '';
			}
			if (pendientes == 0) {
				var nuevo = $('<div id="loading"><p></p></div>');
				nuevo.find('p').html(mensaje);
				$('body').append(nuevo);
			}
			pendientes++;
		};

		var actividadOff = function actividadOff() {
			pendientes--;
			if (pendientes <= 0) {
				pendientes = 0;
				$('#loading').remove();
			}
		};

		return {
			on: actividadOn,
			off: actividadOff
		};
	}();
}
if (!hayValor(moduloHttp)) {
	var moduloHttp = function () {

		var call = function call(url, metodo, encabezados, usarCache, payload, params) {
			if (!hayValor(usarCache)) {
				usarCache = false;
			}
			if (hayValor(params)) {
				url += '?' + $.param(params);
			}
			var diferido = $.Deferred();
			moduloActividad.on();
			var peticion = {
				'url': url,
				'type': metodo,
				'cache': usarCache,
				'headers': {}
			};
			if (hayValor(encabezados)) {
				peticion.headers = encabezados;
			}
			if (hayValor(payload)) {
				peticion.data = JSON.stringify(payload), peticion.headers.contentType = "application/json; charset=utf-8";
			}
			$.ajax(peticion).done(function (datos) {
				diferido.resolve(datos);
			}).fail(function () {
				diferido.reject();
			}).always(function () {
				moduloActividad.off();
			});
			return diferido.promise();
		};

		var get = function get(url, usarCache, params) {
			return call(url, 'GET', null, usarCache, null, params);
		};

		var borrar = function borrar(url) {
			return call(url, 'DELETE');
		};

		var put = function put(url, payload, params) {
			return call(url, 'PUT', null, false, payload, params);
		};

		var post = function post(url, payload, params) {
			return call(url, 'POST', darHeader(), false, payload, params);
		};

		var darToken = function darToken() {
			return $('[name="csrfmiddlewaretoken"]').val();
		};

		var darHeader = function darHeader() {
			return {
				'X-CSRFToken': darToken()
			};
		};

		return {
			'get': get,
			'post': post,
			'put': put,
			'borrar': borrar,
			'darToken': darToken,
			'darHeader': darHeader
		};
	}();
}

if (!hayValor(moduloLocal)) {
	var moduloLocal = function () {
		var props = {
			'lengua': LENGUAJE,
			'lenguapred': LENGUAJE_PRED
		};

		var datos = null;

		var inicializar = function inicializar() {
			var diferido = $.Deferred();
			var promesa = moduloHttp.get('/assets/cmgae/local/' + props.lengua + '.json');
			$.when(promesa).then(function (nuevos) {
				datos = JSON.parse(nuevos);
				diferido.resolve();
			});
			//Se formatean las fechas
			epochAFechaElem($('body'));
			activarBotonesLenguaje();
			return diferido.promise();
		};

		var traducir = function traducir(llave) {
			if (!esObjeto(datos)) {
				return llave;
			}
			return leerObj(datos, llave, llave);
		};

		var procesarElemento = function procesarElemento(elem) {
			$.each(elem.find('.traducir'), function (i, hijoB) {
				var hijo = $(hijoB);
				var llave = hijo.text();
				if (esMultilenguaje(llave)) {
					var traducido = traducir(llave);
					if (traducido != llave) {
						hijo.html(traducido);
					}
				}
			});
		};

		var epochAFecha = function epochAFecha(objeto, formato1) {
			var fechaTexto = objeto.attr("data-value");
			if (fechaTexto) {
				var fecha = new Date(0);
				try {
					fecha.setUTCSeconds(parseInt(fechaTexto));
				} catch (e) {}
				objeto.find("[data-format]").each(function (index, element) {
					var actual = $(element);
					var formato = actual.attr("data-format");
					var formateado = $.format.date(fecha.getTime(), formato);
					actual.text(formateado);
				});
				if (formato1 !== undefined) return $.format.date(fecha.getTime(), formato1);
			}
			return "";
		};

		var epochAFechaElem = function epochAFechaElem(elemento) {
			elemento.find("[dateProperty]").each(function (index, element) {
				var actual = $(element);
				epochAFecha(actual);
			});
		};

		var activarBotonesLenguaje = function activarBotonesLenguaje() {
			$('[data-lenguaje]').each(function (i, elem) {
				var self = $(elem);
				var lenguaje = self.attr('data-lenguaje');
				self.off('click', '**');
				self.on('click', function () {
					var matchCampo = /(http)(s?)(:)(\/\/)(.*?)(\/)((leng-)(.*?)(\/))?(.*)/g.exec(window.location);
					if (matchCampo) {
						var nuevo = '';
						var primeravez = true;
						var actual = matchCampo[9];
						var es_predeterminado = lenguaje === props.lenguapred;
						for (var i = 1; i < matchCampo.length; i++) {
							var temp = matchCampo[i];
							if (i <= 6 || i >= 11) {
								if (temp !== undefined) {
									nuevo += temp;
								}
							} else {
								if (es_predeterminado) {
									if (actual === undefined) {
										return;
									}
								} else {
									if (actual === lenguaje) {
										return;
									}
								}
								if (!es_predeterminado && primeravez) {
									nuevo += 'leng-' + lenguaje + '/';
									primeravez = false;
								}
							}
						}
						window.location = nuevo;
					}
				});
			});
		};

		return {
			'inicializar': inicializar,
			'traducir': traducir,
			'procesarElemento': procesarElemento,
			'epochAFechaElem': epochAFechaElem
		};
	}();
}
//Leer https://ace.c9.io/build/kitchen-sink.html
if (!hayValor(moduloEditorTexto)) {
	var moduloEditorTexto = function moduloEditorTexto(ele) {
		var idLocal = 'pluginEditor-' + new Date().getTime();
		var idActual = null;
		var hashActual = null;

		var destruirEditor = function destruirEditor() {
			ele.empty();
			var nuevo = $('<div/>', { id: idLocal });
			ele.append(nuevo);
			hashActual = null;
		};

		var abrirEditor = function abrirEditor(nombre, contenido, id) {
			idActual = id;
			var mapaTipos = [{ 'patron': /.*\.js/ig, 'editor': 'ace/mode/javascript' }, { 'patron': /.*\.html/ig, 'editor': 'ace/mode/html' }, { 'patron': /.*\.json/ig, 'editor': 'ace/mode/json' }, { 'patron': /.*\.css/ig, 'editor': 'ace/mode/css' }, { 'patron': /.*\.scss/ig, 'editor': 'ace/mode/scss' }, { 'patron': /.*\.xml/ig, 'editor': 'ace/mode/xml' }];
			destruirEditor();
			var editor = ace.edit(idLocal);
			editor.setValue(contenido);
			editor.setTheme("ace/theme/monokai");

			hashActual = MD5(contenido);
			/*
   editor.commands.addCommand({
       name: 'comandoGuardar',
       bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
       exec: function(editor) {
          	guardarArchivo();
       },
       readOnly: true // false if this command should not apply in readOnly mode
   });
   */
			for (var i = 0; i < mapaTipos.length; i++) {
				var unTipo = mapaTipos[i];
				if (unTipo.patron.test(nombre)) {
					editor.getSession().setMode(unTipo.editor);
				}
			}
		};

		var guardarArchivo = function guardarArchivo() {
			if (!haCambiado()) {
				moduloMenus.info('menus.mensajes.sincambios');
				return;
			}
			var editor = ace.edit(idLocal);
			var promesasTodas = moduloArchivos.borrarCacheConId(idActual);
			var contenido = editor.getValue();
			promesasTodas['guardado'] = moduloArchivos.escribirTextoPlano(idActual, contenido);
			$.when(promesasTodas).then(function () {
				moduloMenus.info('menus.mensajes.guardado');
				hashActual = MD5(contenido);
			}, function () {
				alert('Error subiendo el archivo');
			});
		};

		var haCambiado = function haCambiado() {
			var editor = ace.edit(idLocal);
			return hashActual != MD5(editor.getValue());
		};

		return {
			abrirEditor: abrirEditor,
			destruirEditor: destruirEditor,
			guardarArchivo: guardarArchivo,
			haCambiado: haCambiado
		};
	};
}

if (!hayValor(moduloArchivos)) {
	var moduloArchivos = function () {
		var MAX_FILE_SIZE = 550 * 1024; //en KB
		var PREFIJO_LOCAL = '/app_default_bucket';
		var PREFIJO_RAIZ_PUBLICA = '/public';

		var completarPredeterminados = function completarPredeterminados(atributos) {
			var mapa = {
				'maximoTamanio': MAX_FILE_SIZE,
				'tipos': 'image/*',
				'auto': 'true',
				'dataFolder': '/imagenesbasico'
			};
			for (var llave in mapa) {
				if (!hayValor(atributos[llave])) {
					atributos[llave] = mapa[llave];
				}
			}
			return atributos;
		};

		var subirArchivo = function subirArchivo(atributos) {
			var diferido = $.Deferred();
			atributos = completarPredeterminados(atributos);
			var temp = $('<input type="file" class="invisible" accept="' + atributos.tipos + '">');
			temp.on("change", function (e) {
				var file = e.target.files[0];
				if (file.size > atributos.maximoTamanio) {
					alert('Archivo muy grande! debe ser menor a ' + atributos.maximoTamanio / 1024 + ' KB');
					diferido.reject();
					return;
				}
				var subirReal = function subirReal() {
					var reader = new FileReader();
					reader.readAsDataURL(file);
					var form = new FormData();
					form.append('file-0', file);
					form.append('folder', atributos.dataFolder);
					if (hayValor(atributos.id)) {
						form.append('name', decodeURIComponent(atributos.id));
					}
					if (atributos.auto == 'false') {
						form.append('auto', 'false');
					}

					if (hayValor(atributos.url)) {
						console.log(atributos.url);
						var queryParams = darParametrosUrl(atributos.url);
						console.log(queryParams);
						if ('no-borrar' in queryParams) {
							form.append('no-borrar', 'true');
						}
					}
					//Sobra porque el servidor ya lo está capturando
					//form.append('mime', file.type);
					moduloActividad.on();
					$.ajax({
						url: '/storage/',
						type: 'POST',
						data: form,
						headers: moduloHttp.darHeader(),
						cache: false,
						contentType: false,
						processData: false
					}).done(function (data) {
						if (data.error != 0) {
							diferido.reject();
						} else {
							diferido.resolve(data);
						}
					}).fail(function () {
						diferido.reject();
					}).always(function () {
						moduloActividad.off();
					});
				};

				if (estaEnLista(file.name, atributos.opcionesNegras)) {
					var promesaConf = moduloMenus.confirmar();
					$.when(promesaConf).then(function () {
						subirReal();
					});
				} else {
					subirReal();
				}
			});
			temp.click();
			return diferido.promise();
		};

		var escribirTextoPlano = function escribirTextoPlano(id, contenido) {
			var diferido = $.Deferred();
			var extension = '.txt';
			var indicePunto = id.indexOf('.');
			var blobAttrs = { type: "text/plain" };
			if (indicePunto >= 0) {
				var _extension = id.substring(indicePunto);
				_extension = _extension.toLowerCase();
				if (_extension.startsWith('.css') || _extension.startsWith('.scss')) {
					blobAttrs.type = 'text/css';
				} else if (_extension.startsWith('.js')) {
					blobAttrs.type = 'text/javascript';
				}
			}

			var file = new File([contenido], id, blobAttrs);
			var form = new FormData();
			form.append('file-0', file);
			form.append('auto', 'false');
			form.append('name', id);
			moduloActividad.on();
			$.ajax({
				url: '/storage/',
				type: 'POST',
				data: form,
				headers: moduloHttp.darHeader(),
				cache: false,
				contentType: false,
				processData: false
			}).done(function (data) {
				if (data.error != 0) {
					diferido.reject();
				} else {
					diferido.resolve();
				}
			}).fail(function () {
				diferido.reject();
			}).always(function () {
				moduloActividad.off();
			});
			return diferido.promise();
		};

		var leerTextoPlano = function leerTextoPlano(id) {
			var diferido = $.Deferred();
			moduloActividad.on();
			$.ajax({
				url: generarUrlDadoId(id, true),
				type: 'GET',
				cache: false,
				dataType: 'text'
			}).done(function (data, a, b) {
				if (b.status == 204) {
					diferido.reject({ 'error': b.status, 'msg': b.statusText });
				} else {
					diferido.resolve(data);
				}
			}).fail(function (jqXHR, textStatus, errorThrown) {
				diferido.reject({ 'error': textStatus, 'msg': textStatus + ':' + errorThrown });
			}).always(function () {
				moduloActividad.off();
			});
			return diferido.promise();
		};

		var darNombreId = function darNombreId(unId) {
			var PATRON_NOMBRE = /(\/)([^\/]*)$/ig;
			var partes = PATRON_NOMBRE.exec(unId);
			if (partes == null) {
				return null;
			}
			return partes[2];
		};

		/*
   * poner: Agrega el prefijo dependiendo de si es producción o local
   * /app_default_bucket o RAIZ_CLOUD_STORAGE
   */
		var normalizarId = function normalizarId(unId, poner) {
			if (!hayValor(poner)) {
				poner = false;
			}
			var prefijo = null;
			if (moduloApp.esProduccion()) {
				prefijo = moduloApp.darRaizCloudStorage();
			} else {
				prefijo = PREFIJO_LOCAL;
			}
			if (poner === true) {
				if (!unId.startsWith(prefijo)) {
					unId = prefijo + unId;
				}
			} else {
				if (unId.startsWith(prefijo)) {
					unId = unId.substring(prefijo.length);
				}
			}
			return unId;
		};

		var generarUrlDadoId = function generarUrlDadoId(unId, local) {
			var valor;
			if (local != true && moduloApp.esProduccion()) {
				unId = normalizarId(unId, true);
				valor = 'http://storage.googleapis.com' + unId + '?' + new Date().getTime();
			} else {
				unId = normalizarId(unId);
				valor = '/storage/read?name=' + encodeURIComponent(unId);
			}
			return valor;
		};

		var darIdDadoUrl = function darIdDadoUrl(direccion) {
			if (!hayValor(direccion)) {
				return null;
			}
			if (moduloApp.esProduccion()) {
				var PATRON_GOOGLE_STORAGE = /^(https?:\/\/storage\.googleapis\.com)([^\?]+)(\?.*)?$/ig;
				var partes = PATRON_GOOGLE_STORAGE.exec(direccion);
				if (partes != null && partes.length >= 3) {
					return partes[2];
				}
			} else {
				var PATRON_LOCAL_STORAGE = /(\/storage\/read).*(name=)([^\?&]+)/ig;
				var _partes = PATRON_LOCAL_STORAGE.exec(direccion);
				if (_partes != null && _partes.length >= 3) {
					return _partes[3];
				}
			}
			return null;
		};

		var borrar = function borrar(unId) {
			var url = '/storage/borrar?name=';
			url += encodeURIComponent(unId);
			return moduloHttp.borrar(url);
		};

		var renombrar = function renombrar(viejo, nuevo) {
			var url = '/storage/renombrar?';
			url += 'viejo=' + encodeURIComponent(viejo);
			url += '&nuevo=' + encodeURIComponent(nuevo);
			return moduloHttp.get(url);
		};

		var crearBasico = function crearBasico() {
			var idIndex = PREFIJO_RAIZ_PUBLICA + '/index.html';
			var promesa = leerTextoPlano(idIndex);
			$.when(promesa).then(function (datos) {
				//Ya existe!
			}, function (objeto) {
				if (objeto.error == 204) {
					//Se busca crear
					$.ajax({
						url: '/assets/cmgae/ejemplos/index.html',
						type: 'GET',
						cache: false,
						dataType: 'text'
					}).done(function (contenido) {
						var promesaEscritura = escribirTextoPlano(idIndex, contenido);
						$.when(promesaEscritura).then(function () {
							location.reload();
						});
					});
				}
			});
		};

		var borrarCacheRutaAtual = function borrarCacheRutaAtual() {
			return moduloHttp.borrar(location.pathname);
		};

		var borrarCacheConId = function borrarCacheConId(id) {
			var url = normalizarId(id);
			url = eliminarPrefijo(url, darRaizPublica());
			var promesas = {};
			promesas[0] = moduloHttp.borrar(url);
			if (url === '/index.html') {
				promesas[1] = moduloHttp.borrar('/');
			}
			return promesas;
		};

		var darRaizPublica = function darRaizPublica() {
			return PREFIJO_RAIZ_PUBLICA;
		};

		return {
			'darNombreId': darNombreId,
			'normalizarId': normalizarId,
			'leerTextoPlano': leerTextoPlano,
			'escribirTextoPlano': escribirTextoPlano,
			'subirArchivo': subirArchivo,
			'generarUrlDadoId': generarUrlDadoId,
			'darIdDadoUrl': darIdDadoUrl,
			'borrar': borrar,
			'renombrar': renombrar,
			'completarPredeterminados': completarPredeterminados,
			'crearBasico': crearBasico,
			'darRaizPublica': darRaizPublica,
			'borrarCacheConId': borrarCacheConId,
			'borrarCacheRutaAtual': borrarCacheRutaAtual
		};
	}();
}

//Leer https://www.jstree.com/plugins/
if (!hayValor(moduloArbolArchivos)) {
	var moduloArbolArchivos = function moduloArbolArchivos(elem, elemEditor) {

		var tabTemplate = "<li><a href='#{href}'>#{label}</a> <span class='ui-icon ui-icon-close' role='presentation'>Remove Tab</span></li>";
		var mapaTabs = {};
		var editorActual = null;

		var tabs = $("#tabs").tabs({
			activate: function activate(event, ui) {
				var id = $(ui.newPanel).attr('id');
				editorActual = mapaTabs[id];
			}
		});

		var actualizarAlturaTabsNav = function actualizarAlturaTabsNav() {
			var altura = $($('#tabs').find(".ui-tabs-nav")).outerHeight(true);
			$('.pluginEditorInner>.ace_editor').css({ top: altura });
		};

		$(window).on("resize", function () {
			actualizarAlturaTabsNav();
		});

		tabs.on("click", "span.ui-icon-close", function () {
			var tabSeleccionado = $(this);

			//Se mira si ha cambiado o no
			if (editorActual.editor.haCambiado()) {
				//Se pide confirmar en caso que el hash haya cambiado
				var promesaConf = moduloMenus.confirmar('general.perderacambios');
				$.when(promesaConf).then(function () {
					cerrarTab(tabSeleccionado);
				});
			} else {
				cerrarTab(tabSeleccionado);
			}
		});

		jQuery(document).keydown(function (event) {
			// If Control or Command key is pressed and the S key is pressed
			// run save function. 83 is the key code for S.
			if ((event.ctrlKey || event.metaKey) && event.which == 83) {
				// Save Function
				editorActual.editor.guardarArchivo();
				event.preventDefault();
				return false;
			}
		});

		var darNombresHijos = function darNombresHijos(nodo) {
			var hijos = copiarJSON(leerObj(nodo, 'children', []));
			for (var i = 0; i < hijos.length; i++) {
				hijos[i] = moduloArchivos.darNombreId(hijos[i]);
			}
			return hijos;
		};

		var cerrarTab = function cerrarTab(elemTab) {
			var panelId = elemTab.closest("li").remove().attr("aria-controls");
			$("#" + panelId).remove();
			delete mapaTabs[panelId];
			tabs.tabs("refresh");
			actualizarAlturaTabsNav();
		};

		// Actual addTab function: adds new tab using the input from the form above
		function agregarTab(nombreArchivo, contenido, rutaUnica) {

			var label = nombreArchivo,
			    id = MD5('tab-' + rutaUnica),
			    li = $(tabTemplate.replace(/#\{href\}/g, "#" + id).replace(/#\{label\}/g, label));

			if (hayValor(mapaTabs[id])) {
				mapaTabs[id].li.find('a').click();
				return;
			}

			tabs.find(".ui-tabs-nav").append(li);
			tabs.append('<div id="' + id + '" class="pluginEditor"><div class="pluginEditorInner"></div></div>');
			tabs.tabs("refresh");

			mapaTabs[id] = {
				'li': li
			};

			li.find('a').click();

			var instanciaEditorTexto = moduloEditorTexto($('#' + id + ' .pluginEditorInner'));
			instanciaEditorTexto.abrirEditor(nombreArchivo, contenido, rutaUnica);

			mapaTabs[id]['editor'] = instanciaEditorTexto;
			actualizarAlturaTabsNav();
		};

		elem.on("changed.jstree", function (event, data) {
			if (data.selected.length) {
				var ref = data.instance.get_node(data.selected[0]);
			}
		});

		elem.bind("move_node.jstree", function (e, data) {
			console.log(data);
		});

		elem.on("rename_node.jstree", function (event, data) {
			var anterior = data.old;
			var nuevo = data.text;
			var elNodo = data.node;
			var refArbol = data.instance;

			if (elNodo.original.type == 'folder') {
				data.instance.set_id(elNodo, data.node.parent + nuevo + '/');
			} else {
				var viejoId = data.node.parent + anterior;
				var nuevoId = data.node.parent + nuevo;

				var funError = function funError() {
					elNodo.text = anterior;
					elNodo.original.text = anterior;
					refArbol.redraw([elNodo]);
					moduloMenus.error();
				};

				//Validar que otro no se llame igual
				var padre = refArbol.get_node(data.node.parent);
				var hermanos = darNombresHijos(padre);
				if (estaEnLista(nuevo, hermanos)) {
					funError();
				} else {
					var promesa = moduloArchivos.renombrar(viejoId, nuevoId);
					$.when(promesa).then(function (datos) {
						if (datos.error != 0) {
							funError();
						} else {
							data.instance.set_id(elNodo, nuevoId);
						}
					}, funError);
				}
			}
		});

		elem.on("load_node.jstree", function (event, data) {
			var refArbol = data.instance;
			//Se itera sobre los hijos buscando los nodos que son type file
			for (var i = 0; i < data.node.children.length; i++) {
				var elId = data.node.children[i];
				var unNodo = refArbol.get_node(elId);
				ajustarAspectoNodo(unNodo);
			}
		});

		elem.on("create_node.jstree", function (event, data) {
			ajustarAspectoNodo(data.node);
		});

		var ajustarAspectoNodo = function ajustarAspectoNodo(unNodo) {
			if (unNodo.original.type == 'file') {
				elem.jstree(true).set_icon(unNodo.id, "/assets/js/cmgae/jstree/file.png");
			}
		};

		elem.on('dblclick', '.jstree-anchor', function (e) {
			var inst = $.jstree.reference(this),
			    ref = inst.get_node(this);
			abrirNodo(ref);
		});

		var abrirNodo = function abrirNodo(ref) {
			var promesaCargue = moduloArchivos.leerTextoPlano(ref.id);
			$.when(promesaCargue).then(function (contenido) {
				//TODO detectar que es error de que no existe, diferente a otro error
				if (typeof contenido != 'string') {
					contenido = '';
				}
				agregarTab(ref.text, contenido, ref.id);
			}, function (obj) {
				moduloMenus.error(obj.msg);
			});
		};

		var menuALaMedida = function menuALaMedida($node) {
			var abrir = {
				"separator_before": false,
				"separator_after": false,
				"label": "Abrir",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var ref = inst.get_node(data.reference);
					abrirNodo(ref);
				}
			};
			var crearCarpeta = {
				"separator_before": false,
				"separator_after": false,
				"label": "Crear carpeta",
				"action": function action(data) {
					var nuevoNodo = { 'text': 'nuevo', 'type': 'folder' };
					var inst = $.jstree.reference(data.reference),
					    obj = inst.get_node(data.reference);
					inst.create_node(obj, nuevoNodo, "last", function (new_node) {
						//new_node.data = {file: true};
						setTimeout(function () {
							inst.edit(new_node);
						}, 0);
					});
				}
			};

			var crearArchivo = {
				"separator_before": false,
				"separator_after": false,
				"label": "Nuevo archivo",
				"action": function action(data) {
					var nuevoNodo = { 'text': 'nuevo', 'type': 'file' };
					var inst = $.jstree.reference(data.reference),
					    obj = inst.get_node(data.reference);
					nuevoNodo.id = obj.id + nuevoNodo.text;
					var promesaEscritura = moduloArchivos.escribirTextoPlano(nuevoNodo.id, '');
					$.when(promesaEscritura).then(function () {
						inst.create_node(obj, nuevoNodo, "last", function (new_node) {
							//new_node.data = {file: true};
							setTimeout(function () {
								inst.edit(new_node);
							}, 0);
						});
					});
				}
			};

			var renombrar = {
				"separator_before": false,
				"separator_after": false,
				"label": "Renombrar",
				"action": function action(obj) {
					var inst = $.jstree.reference(obj.reference);
					inst.edit($node);
				}
			};

			var borrar = {
				"separator_before": false,
				"separator_after": false,
				"label": "Borrar",
				"action": function action(data) {
					var promesaConf = moduloMenus.confirmar();
					$.when(promesaConf).then(function () {
						var inst = $.jstree.reference(data.reference),
						    obj = inst.get_node(data.reference);
						var promesa = moduloArchivos.borrar(obj.id);
						$.when(promesa).then(function (respuesta) {
							if (respuesta.error == 0) {
								var inst = $.jstree.reference(data.reference);
								inst.delete_node($node);
							} else {
								moduloMenus.error();
							}
						}, moduloMenus.error);
					});
				}
			};

			var cargar = {
				"separator_before": false,
				"separator_after": false,
				"label": "Subir",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var obj = inst.get_node(data.reference);
					var rutaDestino = quitarUltimoSlash(obj.id);
					var hijos = darNombresHijos(obj);
					var promesa = moduloArchivos.subirArchivo({
						auto: 'false',
						tipos: 'audio/*|video/*|image/*|text/*',
						opcionesNegras: hijos,
						dataFolder: rutaDestino
					});
					$.when(promesa).then(function (resultado) {
						var nombreArchivo = moduloArchivos.darNombreId(resultado.id);
						if (!estaEnLista(nombreArchivo, hijos)) {
							var nuevoNodo = {
								'text': nombreArchivo,
								'type': 'file',
								'id': moduloArchivos.normalizarId(resultado.id, false)
							};
							inst.create_node(obj, nuevoNodo, "last", function (new_node) {});
						}
					}, moduloMenus.error);
				}
			};

			var copiarRuta = {
				"separator_before": false,
				"separator_after": false,
				"label": "URL",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var obj = inst.get_node(data.reference);
					var url = moduloArchivos.generarUrlDadoId(obj.id);
					if (urlContieneExtension(url, ['css', 'scss'])) {
						url = '<link rel="stylesheet" href="' + url + '"/>';
					} else if (urlContieneExtension(url, ['js'])) {
						url = '<script src="' + url + '"></script>';
					}
					copiarEnPortapapeles(url);
				}
			};

			var copiarRutaLocal = {
				"separator_before": false,
				"separator_after": false,
				"label": "URL Local",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var obj = inst.get_node(data.reference);
					var url = moduloArchivos.normalizarId(obj.id);
					url = eliminarPrefijo(url, moduloArchivos.darRaizPublica());
					if (urlContieneExtension(url, ['css', 'scss'])) {
						url = '<link rel="stylesheet" href="' + url + '"/>';
					} else if (urlContieneExtension(url, ['js'])) {
						url = '<script src="' + url + '"></script>';
					}
					copiarEnPortapapeles(url);
				}
			};

			var copiarRutaBruta = {
				"separator_before": false,
				"separator_after": false,
				"label": "URL Bruta",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var obj = inst.get_node(data.reference);
					var url = moduloArchivos.normalizarId(obj.id);
					copiarEnPortapapeles(url);
				}
			};

			var borrarCacheArchivo = {
				"separator_before": false,
				"separator_after": false,
				"label": "Borrar Cache",
				"action": function action(data) {
					var inst = $.jstree.reference(data.reference);
					var obj = inst.get_node(data.reference);
					var promesas = moduloArchivos.borrarCacheConId(obj.id);
					$.when(promesas, function () {}, function () {});
				}
			};

			//solo se deben poder mover archivos.
			if ($node.original.type == 'folder') {
				return {
					'CrearArchivo': crearArchivo,
					'CrearCarpeta': crearCarpeta,
					'Cargar': cargar,
					"Borrar": borrar //Solo si no tiene hijos
				};
			} else if ($node.original.type == 'file') {
				return {
					'Abrir': abrir,
					'copiarRuta': copiarRuta,
					'copiarRutaLocal': copiarRutaLocal,
					'copiarRutaBruta': copiarRutaBruta,
					//'borrarCacheArchivo': borrarCacheArchivo,
					'Renombrar': renombrar,
					"Borrar": borrar
				};
			}
		};

		elem.jstree({
			"core": {
				"check_callback": true,
				"themes": { "stripes": true },
				'data': {
					'url': function url(node) {
						return "/storage/jstreelist";
					},
					'dataType': "json",
					"data": function data(node) {
						return { "id": node.id };
					}
				}

			},
			'contextmenu': {
				'items': menuALaMedida
			},
			"plugins": ["contextmenu", "dnd", "search", "json_data", "state", "wholerow"]
		});

		$(document).keydown(function (e) {
			if (e.keyCode == 65 && e.ctrlKey) {
				moduloArchivos.crearBasico();
			}
		});

		return {
			'actualizarAlturaTabsNav': actualizarAlturaTabsNav
		};
	};
}
if (!hayValor(moduloApp)) {
	var moduloApp = function () {

		var props = {
			'URL_LOGIN': URL_LOGIN,
			'URL_LOGOUT': URL_LOGOUT,
			'HAS_USER': HAS_USER,
			'IS_ADMIN': IS_ADMIN,
			'AMBIENTE': AMBIENTE,
			'RAIZ_CLOUD_STORAGE': RAIZ_CLOUD_STORAGE
		};

		var esPruebas = function esPruebas() {
			return props.AMBIENTE == 'pruebas';
		};

		var esProduccion = function esProduccion() {
			return props.AMBIENTE == 'produccion';
		};

		var esAdmin = function esAdmin() {
			return props.IS_ADMIN;
		};

		var esUsuario = function esUsuario() {
			return props.HAS_USER;
		};

		var darRaizCloudStorage = function darRaizCloudStorage() {
			return props.RAIZ_CLOUD_STORAGE;
		};

		var login = function login() {
			moduloActividad.on();
			window.location.href = props.URL_LOGIN;
		};

		var logout = function logout() {
			moduloActividad.on();
			window.location.href = props.URL_LOGOUT;
		};

		var abrirBarraEdicion = function abrirBarraEdicion() {
			if ($('body').data('Midgard-midgardToolbar').options.display === 'full') {
				$('body').data('Midgard-midgardToolbar').__proto__.hide();
				$('body').data('Midgard-midgardToolbar').options.display = 'minimized';
			} else {
				$('body').data('Midgard-midgardToolbar').__proto__.show();
				$('body').data('Midgard-midgardToolbar').options.display = 'full';
			}
		};

		var borrarCache = function borrarCache() {
			var diferido = $.Deferred();
			moduloActividad.on();
			$.ajax({
				type: "GET",
				url: "/act/clearmemcache",
				data: JSON.stringify({}),
				contentType: "application/json; charset=utf-8"
			}).done(function (msg) {
				diferido.resolve();
			}).fail(function (jqXHR, textStatus) {
				diferido.reject();
			}).always(function () {
				moduloActividad.off();
			});
			return diferido.promise();
		};

		var inicializar = function inicializar() {
			var diferido = $.Deferred();
			diferido.resolve();
			return diferido.promise();
		};

		var enviarCorreo = function enviarCorreo(datos) {
			var promesa = moduloHttp.put('/act/correo', datos);
			return promesa;
		};

		return {
			'esAdmin': esAdmin,
			'esUsuario': esUsuario,
			'login': login,
			'logout': logout,
			'borrarCache': borrarCache,
			'abrirBarraEdicion': abrirBarraEdicion,
			'esProduccion': esProduccion,
			'esPruebas': esPruebas,
			'darRaizCloudStorage': darRaizCloudStorage,
			'enviarCorreo': enviarCorreo
		};
	}();
}
if (!hayValor(moduloImagenes)) {
	var moduloImagenes = function () {
		var PATRON_FONDO = /(background-image\s*:\s*url\s*\(\s*['"]?)([^'^"]*?)(\s*['"]?\))\s*(!\s*important)?\s*(;)?/ig;

		var asignarSrc = function asignarSrc(elem, unId, esEstilo) {
			var valor = moduloArchivos.generarUrlDadoId(unId);
			if (esEstilo) {
				//Se trata de una imagen de fondo
				var original = elem.attr('style');
				original = original.replace(PATRON_FONDO, '');
				original = original.trim();
				if (hayValor(original) && !original.endsWith(';')) {
					original = original + ';';
				}
				original += 'background-image: url(\'' + valor + '\') !important;';
				elem.attr('style', original);
				return original;
			} else {
				elem.attr('src', valor);
			}
			return valor;
		};

		var darUrlAnterior = function darUrlAnterior(elem, esEstilo) {
			var direccion = null;
			if (esEstilo) {
				var original = elem.attr('style');
				var partesEstilo = PATRON_FONDO.exec(original);
				if (partesEstilo != null && partesEstilo.length > 3) {
					direccion = partesEstilo[2];
				}
			} else {
				direccion = elem.attr('src');
			}
			return direccion;
		};

		var darIdAnterior = function darIdAnterior(elem, esEstilo) {
			var direccion = darUrlAnterior(elem, esEstilo);
			return moduloArchivos.darIdDadoUrl(direccion);
		};

		var darValoresCargue = function darValoresCargue(self) {
			var props = moduloArchivos.completarPredeterminados({});
			//Se valida si el html declara un tamaño máximo específico
			try {
				var valorDataMax = self.attr('data-max');
				if (hayValor(valorDataMax)) {
					props.maximoTamanio = parseInt(valorDataMax) * 1024;
				}
			} catch (e2) {
				console.log('Intentó determinar tamaño máximo de imagen pero falló');
			}
			//Se valida si el html declara una carpeta específica
			var attrDataFolder = self.attr('data-carpeta');
			if ((typeof attrDataFolder === 'undefined' ? 'undefined' : _typeof(attrDataFolder)) !== (typeof undefined === 'undefined' ? 'undefined' : _typeof(undefined)) && attrDataFolder !== false) {
				attrDataFolder = attrDataFolder.trim();
				if (hayValor(attrDataFolder)) {
					if (attrDataFolder.charAt(0) != '/') {
						attrDataFolder = '/' + attrDataFolder;
					}
					props.dataFolder += attrDataFolder;
				}
			}
			return props;
		};

		return {
			'asignarSrc': asignarSrc,
			'darIdAnterior': darIdAnterior,
			'darUrlAnterior': darUrlAnterior,
			'darValoresCargue': darValoresCargue
		};
	}();
}

if (!hayValor(moduloEdicion)) {
	var moduloEdicion = function () {
		var mapaIds = {};
		var activarEdicionOk = false;
		var vie = null;

		var configureEditorsHere = function configureEditorsHere() {
			jQuery('body').midgardCreate('configureEditor', 'default', 'halloWidget', {
				plugins: { 'halloformat': {}, 'halloblock': {}, 'hallolists': {}, 'hallolink': {}, 'halloreundo': {} } });

			jQuery('body').midgardCreate('configureEditor', 'plaintext', 'halloWidget', {
				plugins: { 'halloreundo': {} } });

			jQuery('body').midgardCreate('setEditorForProperty', 'TextSimple', 'plaintext');

			jQuery('body').midgardCreate('configureEditor', 'nuevo', 'halloWidget', {
				plugins: {
					halloformat: {},
					halloblacklist: {
						tags: ['br']
					}
				}
			});
		};

		var activarEdicion = function activarEdicion() {
			if (activarEdicionOk == true) {
				return;
			}
			if (typeof Backbone != 'undefined') {
				Backbone.sync = function (method, model, options) {
					try {
						var temp = model.toJSON();
						var viejo = temp['@subject'];
						if (model.isNew()) {
							if (viejo in mapaIds) {
								temp['@subject'] = mapaIds[viejo];
							} else {
								temp['@subject'] = '<' + new Date().getTime() + "_" + Math.floor(Math.random() * 10 + 1) + '>';
								mapaIds[viejo] = temp['@subject'];
							}
						}

						var ident = temp['@subject'];
						var tipo = temp['@type'];

						var matchCampo = /(viejs\.org\/ns\/)(.*)(>)/g.exec(tipo);
						var tipoNombre = null;
						if (matchCampo) {
							tipoNombre = matchCampo[2];
						}

						var patronIdent = /(<)(.*)(>)/g;
						var matchIdent = patronIdent.exec(ident);

						if (matchIdent == null) {
							options.error('error: no es identificador ' + ident);
							return;
						}

						var matchIdentFinal = matchIdent[2];
						var contenido = {};

						for (var key in temp) {
							var matchCampo = /(viejs\.org\/ns\/)(.*)(>)/g.exec(key);
							if (matchCampo) {
								contenido[matchCampo[2]] = temp[key];
							}
						}

						var completo = {};
						completo['payload'] = contenido;
						completo['leng'] = LENGUAJE;
						//completo['tipo'] = tipoNombre;
						switch (method) {
							case 'create':
							case 'update':
								moduloActividad.on();
								$.ajax({
									type: "POST",
									url: "/rest/" + (tipoNombre === null || tipoNombre === undefined ? 'Documento' : tipoNombre) + "/" + matchIdentFinal,
									data: JSON.stringify(completo),
									headers: moduloHttp.darHeader(),
									contentType: "application/json; charset=utf-8"
								}).done(function (msg) {
									//Se borra la cache actual
									moduloArchivos.borrarCacheRutaAtual();
									options.success(model);
								}).fail(function (jqXHR, textStatus) {
									options.error('error');
								}).always(function () {
									moduloActividad.off();
								});
								break;
							case 'delete':
								break;
							case 'read':
								break;
						}
					} catch (e) {
						options.error('error ' + e);
					}
				};
				activarEdicionOk = true;
			}
		};

		var activarPaginacion = function activarPaginacion(nodo) {
			if (!hayValor(nodo)) {
				nodo = $('body');
			}

			function activatePageA(actual) {
				var cursor = actual.attr('data-next');
				var busqueda = JSON.parse(actual.attr('data-q'));
				var template = actual.attr('data-tpl');
				var target = actual.attr('data-target');
				var ipage = parseInt(actual.attr('data-page'));

				if (!busqueda['n']) {
					busqueda['n'] = 100; //valor predeterminado en python def buscarGQL(objeto)
				}
				if (!moduloApp.esAdmin()) {
					actual.html(ipage * busqueda['n'] + 1 + " al " + (ipage + 1) * busqueda['n']);
				}

				if (actual.attr("data-noa") === "1") {
					actual.removeAttr("href");
					actual.on('click', function () {

						var docHtml = document.getElementById(template).innerHTML;

						var destino = $(target);
						var postload = destino.attr('data-postload');
						if (destino.length > 0) {
							moduloActividad.on();
							$.ajax({
								type: "PUT",
								url: "/paginar/",
								data: JSON.stringify({ busqueda: busqueda, cursor: cursor }),
								contentType: "application/json; charset=utf-8"
							}).done(function (msg) {
								var datos = msg['datos'];
								var sigui = msg['next'];
								destino.empty();
								for (var i = 0; i < datos.length; i++) {
									var dato = datos[i];
									var nuevo = $(docHtml);
									llenarTemplate(nuevo, dato);
									destino.append(nuevo);
								}
								//Se mira si se debe crear un boton de siguiente
								if (sigui !== undefined && sigui.length > 0) {
									var padrePaginacion = actual.closest('.paginacion');
									if (padrePaginacion.find("[data-next='" + sigui + "']").length == 0) {

										var padreLocal = actual.parent();
										var nombreTAG = padreLocal.prop("tagName");
										var cambio = false;
										while (padreLocal.get(0) != padrePaginacion.get(0) && nombreTAG != 'BODY') {
											cambio = true;
											actual = padreLocal;
											padreLocal = padreLocal.parent();
											nombreTAG = padreLocal.prop("tagName");
										}
										var paginaSigui = actual.clone();
										var paginaSigui2;
										if (cambio) {
											paginaSigui2 = paginaSigui.find('[data-next]');
										} else {
											paginaSigui2 = paginaSigui;
										}
										paginaSigui2.attr("data-page", ipage + 1);
										paginaSigui2.attr("data-next", sigui);

										padrePaginacion.append(paginaSigui);
										activatePageA(paginaSigui2);
									}
								}

								if (postload !== undefined) {
									eval(postload);
								}
							}).fail(function (jqXHR, textStatus) {
								moduloMenus.mostrarMenuSoloTexto('Error paginando');
							}).always(function () {
								moduloActividad.off();
							});
						}
					});
				}
			};

			$.each(nodo.find("a[data-next]"), function (index, element) {
				var actual = $(element);
				activatePageA(actual);
			});
		};

		var funcElegirBorrar = function funcElegirBorrar() {
			var botones = $('.btnEliminar');
			if (botones.length > 0) {
				botones.remove();
			} else {
				$('[about]').each(function (indice, elem) {
					var self = $(elem);
					var panelEliminar = self.find('.btnEliminar');
					if (panelEliminar.length == 0) {
						self.prepend($('<div class="btnEliminar"><div class="btnEliminarX btnEliminar2 manito"></div></div>'));
						panelEliminar = self.find('.btnEliminar');
						var botonEliminar = panelEliminar.find('.btnEliminar2');
						botonEliminar.click(function () {
							var promesa = moduloMenus.confirmar();
							$.when(promesa).then(function () {
								var entidad = self;
								var ident = entidad.attr('about');
								var tipoNombre = null;
								tipoNombre = entidad.attr('typeof');

								var miLlave = (!hayValor(tipoNombre) ? '' : tipoNombre) + '_' + ident;
								if (miLlave in mapaIds) {
									ident = mapaIds[miLlave];
								}
								moduloActividad.on();
								$.ajax({
									type: "DELETE",
									url: "/rest/" + (!hayValor(tipoNombre) ? '' : tipoNombre) + '/' + ident
								}).done(function (msg) {
									entidad.remove();
									$('body').data('Midgard-midgardNotifications').create({ body: JSON.stringify(msg) });
									location.reload();
								}).fail(function (jqXHR, textStatus) {
									$('body').data('Midgard-midgardNotifications').create({ body: TRADUCTOR['error_ajax'][LENGUAJE] });
								}).always(function () {
									moduloActividad.off();
								});
								moduloMenus.sacarUltimo();
							}, function () {
								moduloMenus.sacarUltimo();
							});
						});
					}
				});
			}
		};

		var funcionAsignarPropiedadDeNodo = function funcionAsignarPropiedadDeNodo(vie, nomNodo, nomProp, nuevo, sufijo) {
			var sql = "[about='" + nomNodo + "'] [property='" + nomProp + "']";
			var sql2 = "[about='" + nomNodo + "'] [styleProperty='" + nomProp + "'],[about='" + nomNodo + "'][styleProperty='" + nomProp + "']";

			if (!hayValor(sufijo)) {
				sufijo = '';
			}

			var notificarCambio = function notificarCambio() {
				var dato = {};
				dato[nomProp + sufijo] = nuevo;
				var modelo = vie.entities.get(nomNodo);
				modelo.set(dato);

				//para notificar a createjs que cambio
				var cambiados = $('body').data('Midgard-midgardStorage').changedModels;
				if (_.indexOf(cambiados, modelo) === -1) {
					cambiados.push(modelo);
				}
				$('#midgardcreate-save').button({ disabled: false });
			};

			var objeto = $(sql);
			var objeto2 = $(sql2);
			if (objeto.length > 0) {
				var nombreTag = objeto.prop("tagName");
				if (nombreTag == 'IMG') {
					if (sufijo == '_alt') {
						objeto.attr("alt", nuevo);
					} else {
						objeto.attr("src", nuevo);
					}
				}
				notificarCambio();
			} else if (objeto2.length > 0) {
				nuevo = nuevo.replace(/"/g, '&quot;');
				objeto2.attr('style', nuevo);
				notificarCambio();
				//objeto.html(nuevo);//TODO esto dónde va??
			}
		};

		var activarEstilosEditables = function activarEstilosEditables(objeto) {
			objeto.find('[styleProperty]').each(function (index, element) {
				var self = $(element);
				if (self.attr("act_style") !== "ok") {
					var propiedad = self.attr('styleProperty');
					var padre;
					if (self.attr('about') !== undefined) {
						padre = self;
					} else {
						padre = self.closest('[about]');
					}
					if (padre === undefined) {
						return;
					}
					self.on("click", function (e) {
						if (e.shiftKey) {
							//Se permite editar el estilo
							var valorAnterior = self.attr('style');
							moduloMenus.mostrarFormularioEdicion(padre.attr('about'), propiedad, valorAnterior);
						} else if (e.ctrlKey) {
							//Se permtie diréctamente actualizar el fondo
							abrirFileChooser(self, propiedad);
						}
					});
					self.attr("act_style", "ok");
				}
			});
		};

		//------------------imagenes---------------------
		var comunEdicionImagenes = function comunEdicionImagenes(self, propEstilo) {
			var respuesta = {
				ok: false
			};
			if ($('#midgardcreate-save').css('display') === 'none') {
				return respuesta;
			}

			if (self.attr('about') !== undefined) {
				respuesta.padre = self;
			} else {
				respuesta.padre = self.closest('[about]');
			}

			if (respuesta.padre === undefined) {
				return respuesta;
			}

			respuesta.ident = respuesta.padre.attr('about');
			if (hayValor(propEstilo)) {
				respuesta.propiedad = propEstilo;
			} else {
				respuesta.propiedad = self.attr('property');
			}
			if (respuesta.ident === undefined || respuesta.propiedad === undefined) {
				return respuesta;
			}
			respuesta.ok = true;
			return respuesta;
		};

		var abrirAltEditor = function abrirAltEditor(self) {
			if (self.prop("tagName") !== 'IMG') {
				return;
			}
			var attrs = comunEdicionImagenes(self);
			if (attrs.ok == false) {
				return;
			}
			moduloMenus.mostrarFormularioEdicion(attrs.ident, attrs.propiedad, self.attr('alt'), '_alt');
		};

		//Todas las imágenes podrán cambiar con click
		var abrirFileChooser = function abrirFileChooser(self, propEstilo) {
			var attrs = comunEdicionImagenes(self, propEstilo);
			if (attrs.ok == false) {
				return;
			}

			var valoresCargue = moduloImagenes.darValoresCargue(self);

			var parametros = {
				dataFolder: valoresCargue.dataFolder,
				id: moduloImagenes.darIdAnterior(self, hayValor(propEstilo)),
				url: moduloImagenes.darUrlAnterior(self, hayValor(propEstilo)),
				maximoTamanio: valoresCargue.maximoTamanio
			};

			var promesaCargue = moduloArchivos.subirArchivo(parametros);

			$.when(promesaCargue).then(function (data) {
				var valor = moduloImagenes.asignarSrc(self, data.id, hayValor(propEstilo));
				funcionAsignarPropiedadDeNodo(vie, attrs.ident, attrs.propiedad, valor);
			});
		};

		var activarImagenes = function activarImagenes(objeto) {
			objeto.find('img[property]').each(function (index, element) {
				var actual = $(element);
				if (actual.attr("act_img") !== "ok") {
					$(element).on('click', function (e) {
						var elemJq = $(element);
						if (e.altKey) {
							//Permite modificar el texto alternativo
							abrirAltEditor(elemJq);
						} else {
							//Permite modificar la imagen
							abrirFileChooser(elemJq);
						}
					});
					actual.attr("act_img", "ok");
				}
			});
		};

		//------------------imagenes---------------------

		//------------------html editables---------------------
		var activarEditables = function activarEditables(objeto) {
			objeto.find('.editable').each(function (index, element) {
				var actual = $(element);
				if (actual.attr("act_edt") !== "ok") {
					actual.on('click', function () {
						var padre = actual.closest('[about]');
						if (padre) {
							if ($('#midgardcreate-save').css('display') === 'none') {
								return;
							}
							moduloMenus.mostrarFormularioEdicion(padre.attr('about'), actual.attr('property'), actual.html());
						}
					});
					actual.attr("act_edt", "ok");
					//Se intenta agregar un elemento que permita edición después de creación
					if (!actual.hasClass('textarea_background')) {
						//? TODO decidir se para los fondos se va a hacer así
						var nuevoBoton = $('<button type="button" style="padding: 5px !important;">editar</button>');
						nuevoBoton.bind('click', function () {
							actual.click();
						});
						actual.after(nuevoBoton);
					}
				}
			});
		};
		//------------------html editables---------------------

		var activarTextoPlano = function activarTextoPlano(objeto) {
			objeto.find('[textplain="true"]').each(function (index, element) {
				var actual = $(element);
				if (actual.attr("act_tpl") !== "ok") {
					actual.on('blur', function () {
						actual.html(actual.text());
					});
					actual.attr("act_tpl", "ok");
				}
			});
		};

		//------------------html fechas---------------------
		var activarFechas = function activarFechas(objeto) {
			objeto.find("[dateProperty]").each(function (index, element) {
				var actual = $(element);
				var nomPropiedad = actual.attr("dateProperty");
				if (actual.attr("act_date") !== "ok") {
					var padre = actual.closest('[about]');
					if (padre) {
						var valorViejo = formatearFecha(actual, 'dd/MM/yyyy');
						var nuevo = $('<input style="display: none;" class="datepicker" type="text" autofocuss value="' + valorViejo + '" data-valuee="' + valorViejo + '"></input>');
						padre.append(nuevo);
						//TODO verificar porque a veces no funciona
						actual.click(function () {
							nuevo.click();
							//nuevo.focus();
						});

						var nuevoProp = $('<div style="display: none;" property="' + nomPropiedad + '">' + actual.attr("data-value") + '</div>');
						padre.append(nuevoProp);

						nuevo.on('change', function () {
							var nomProp = nomPropiedad;
							var dato = {};

							var txtNueVal = "0";
							try {
								txtNueVal = parseInt(toDate(nuevo.val()).getTime() / 1000);
							} catch (e) {}

							dato[nomProp] = txtNueVal;
							var modelo = vie.entities.get(padre.attr("about"));
							modelo.set(dato);

							//para notificar a createjs que cambio
							var cambiados = $('body').data('Midgard-midgardStorage').changedModels;
							if (_.indexOf(cambiados, modelo) === -1) {
								cambiados.push(modelo);
							}
							$('#midgardcreate-save').button({ disabled: false });

							actual.attr("data-value", txtNueVal);
							nuevoProp.text(txtNueVal);
							formatearFecha(actual);
						});

						nuevo.pickadate({
							format: 'dd/mm/yyyy',
							formatSubmit: 'dd/mm/yyyy',
							closeOnSelect: true,
							closeOnClear: true,
							selectMonths: true,
							selectYears: true
						});
					}
					actual.attr("act_date", "ok");
				}
			});
		};
		//------------------html fechas---------------------

		var inicializar = function inicializar() {
			var diferido = $.Deferred();

			if (typeof getVieHere !== 'undefined' && esFuncion(getVieHere)) {
				try {
					vie = getVieHere();
				} catch (e) {
					console.log('Error obteniendo vie', e);
				}
			}

			if (!hayValor(vie) && typeof VIE !== 'undefined') {
				vie = new VIE();
			}

			//Cuando se instancia inicializa la paginación de lo que exista en el body
			activarEdicion();
			activarPaginacion();

			//Se agrega el elemento que permitira subir archivos
			$("body").append($("<input type='file' id=\"formularioImagenes\" class=\"fileEscondido\" nodo2=\"\" property2=\"\" />"));

			//Se agrega el elemento que permite editar html
			$("body").append($('<div class="formhtml invisible">' + '	<div class="ctrles"><a class="guardar">Guardar</a>&nbsp;<a class="cancelar">Cancelar</a></div>' + '	<div class="boxtexto">' + '	<textarea></textarea>' + '	</div>' + '</div>'));

			activarEstilosEditables($('body'));
			activarImagenes($('body'));
			activarEditables($('body'));
			activarTextoPlano($('body'));
			activarFechas($('body'));
			//midgardeditableenable cuando una entidad es editable
			//midgardeditablechanged cuando la propiedad fue modificada
			//midgardeditableenableproperty al hacerse editable
			$('body').bind('midgardeditableenable', function (event, data) {
				var ident = data.entity['@subject'];
				var patronIdent = /(<)(.*)(>)/g;
				var matchIdent = patronIdent.exec(ident);
				if (matchIdent) {
					matchIdent = matchIdent[2];
				} else {
					matchIdent = ident;
				}

				var objeto = $("[about='" + matchIdent + "']");
				if (objeto !== undefined) {
					activarEstilosEditables(objeto); //debe ser antes que activarEditables
					activarImagenes(objeto);
					activarEditables(objeto);
					activarTextoPlano(objeto);
					activarFechas(objeto);
				}
			});
			// Instantiate Create
			$('body').midgardCreate({
				url: function url() {
					return 'javascript:false;';
				},
				vie: vie,
				//toolbar: 'full',//full or minimized
				highlight: false,
				//state: 'edit',//browse or edit tiene problemas cuando muestra los controles de formato posibles
				collectionWidgets: {
					'default': 'midgardCollectionAdd'
					//'default': 'midgardCollectionAddBetween',
					//'feature': 'midgardCollectionAdd'
				}
			});

			configureEditorsHere();

			var templatebotoneditar = "<div class='editableicon'></div>";
			$('.formhtml .cancelar').click(function () {
				$('.formhtml').addClass('invisible');
				//if (pila[pila.length-1] === "formhtml") {pila.pop();}
			});
			$('.formhtml .guardar').click(function () {
				try {
					var formulario = $('.formhtml');
					var nomNodo = formulario.attr('nodo2');
					var nomProp = formulario.attr('property2');
					var sufijo = formulario.attr('sufijo');
					var nuevo = $('.formhtml textarea').val();
					funcionAsignarPropiedadDeNodo(vie, nomNodo, nomProp, nuevo, sufijo);
					$('.formhtml').addClass('invisible');
					//if (pila[pila.length-1] === "formhtml") {pila.pop();}
				} catch (e) {
					$('body').data('Midgard-midgardNotifications').create({ body: "Error " + e });
				}
			});
			$("#formularioImagenes").change(function readImage() {
				if (this.files && this.files[0]) {
					var FR = new FileReader();
					FR.onload = function (e) {
						var formulario = $("#formularioImagenes");
						var nomNodo = formulario.attr('nodo2');
						var nomProp = formulario.attr('property2');
						var objeto = $("[about='" + nomNodo + "'] [property='" + nomProp + "']");
						var dato = {};
						dato[nomProp] = e.target.result;
						if (objeto) {
							if (objeto.prop("tagName") == 'IMG') {
								objeto.attr("src", e.target.result);
							} else {
								//asigna la imagen en el estilo
								objeto.attr("style", "background-image: url('" + e.target.result + "') !important");
							}

							var modelo = vie.entities.get(nomNodo);
							modelo.set(dato);

							//para notificar a createjs que cambio
							var cambiados = $('body').data('Midgard-midgardStorage').changedModels;
							if (_.indexOf(cambiados, modelo) === -1) {
								cambiados.push(modelo);
							}
							$('#midgardcreate-save').button({ disabled: false });
						}
					};
					FR.readAsDataURL(this.files[0]);
				}
			});

			$('textarea[property]').on('change keyup paste', function () {
				self = $(this);
				var propiedad = self.attr('property');
				var padre = self.closest('[about]');
				if (padre) {
					var ident = padre.attr('about');
					var valor = self.val();

					var dato = {};
					dato[propiedad] = valor;
					var modelo = vie.entities.get(ident);
					modelo.set(dato);

					//para notificar a createjs que cambio
					var cambiados = $('body').data('Midgard-midgardStorage').changedModels;
					if (_.indexOf(cambiados, modelo) === -1) {
						cambiados.push(modelo);
					}
					$('#midgardcreate-save').button({ disabled: false });
				}
			});

			return diferido.promise();
		};

		return {
			'inicializar': inicializar,
			'activarPaginacion': activarPaginacion,
			'activarEdicion': activarEdicion,
			'funcElegirBorrar': funcElegirBorrar
		};
	}();
}
if (!hayValor(moduloMenus)) {
	var moduloMenus = function () {

		var pilaLocal = [];

		var cargarHtml = function cargarHtml(ruta) {
			return moduloHttp.get('/assets/cmgae/menus' + ruta, true);
		};

		var esUltimoId = function esUltimoId(id) {
			if (pilaLocal.length == 0) {
				return false;
			}
			return pilaLocal[pilaLocal.length - 1].id == id;
		};

		var sacarUltimo = function sacarUltimo() {
			if (pilaLocal.length == 0) {
				return;
			}
			var elem = pilaLocal[pilaLocal.length - 1].nodo;
			elem.remove();
			pilaLocal.pop();
		};

		var mostrarMenuSoloTexto = function mostrarMenuSoloTexto(texto) {
			var promesa = cargarHtml('/soloTexto.html');
			$.when(promesa).then(function (datos) {
				agregarNodoPila('alerta', datos, { html: { '.mensaje_texto': texto } });
			});
		};

		var info = function info(texto) {
			mostrarMenuSoloTexto(moduloLocal.traducir(texto));
		};

		var error = function error(mensaje) {
			if (!hayValor(mensaje)) {
				mensaje = '';
			}
			mostrarMenuSoloTexto(moduloLocal.traducir('menus.mensajes.error') + ' ' + mensaje);
		};

		var notificar = function notificar(promesa) {
			$.when(promesa).then(function () {
				mostrarMenuSoloTexto(moduloLocal.traducir('menus.mensajes.hecho'));
			}, error);
		};

		var verPropiedadesDePagina = function verPropiedadesDePagina() {
			$('.menu_pagina').removeClass('invisible');
		};

		var esconderPropiedadesDePagina = function esconderPropiedadesDePagina() {
			$('.menu_pagina').addClass('invisible');
		};

		var activarNodo = function activarNodo(nodo, otroMapa) {
			moduloLocal.procesarElemento(nodo);
			var mapa = {
				funciones: {
					'.menu_opc_ingresar': moduloApp.login,
					'.menu_opc_salir': moduloApp.logout,
					'.menu_opc_borrar_cache': moduloApp.borrarCache,
					'.create-ui-toggle2': moduloApp.abrirBarraEdicion,
					'.menuEliminar': moduloEdicion.funcElegirBorrar,
					'.menu_opc_propiedades_pagina': verPropiedadesDePagina
				},
				html: {},
				botones: {}
			};
			mapa = $.extend(mapa, otroMapa);
			$.each(mapa.funciones, function (clase, funcion) {
				nodo.find(clase).on('click', function () {
					sacarUltimo();
					var promesa = funcion();
					if (hayValor(promesa)) {
						notificar(promesa);
					}
				});
			});
			if (esObjeto(mapa.botones)) {
				var contenedor = $('<div class="row"><div class="col-xs-12"><div class="text-right botones-aca"></div></div></div>');
				var predefinido = { texto: '?', clase: 'btn-primary', accion: function accion() {} };
				$.each(mapa.botones, function (llave, detalle) {
					predefinir(detalle, predefinido);
					var nuevoBoton = $('<button type="button" class="btn btn-xs"></button>');
					nuevoBoton.on('click', detalle.accion);
					nuevoBoton.addClass(detalle.clase);
					nuevoBoton.text(detalle.texto);
					contenedor.find('.botones-aca').append(nuevoBoton);
				});
				nodo.append(contenedor);
			}
			for (var clase in mapa.html) {
				nodo.find(clase).html(mapa.html[clase]);
			}
		};

		var confirmar = function confirmar(mensaje) {
			var promesa = cargarHtml('/confirmar.html');
			var diferido = $.Deferred();
			$.when(promesa).then(function (data) {
				if (hayValor(mensaje)) {
					data = data.replace('general.confirme', mensaje);
				}
				var otros = {
					'botones': {
						'aceptar': {
							'texto': moduloLocal.traducir('menus.botones.aceptar'),
							'clase': 'btn-success',
							'accion': function accion() {
								sacarUltimo();
								diferido.resolve();
							}
						},
						'cancelar': {
							'texto': moduloLocal.traducir('menus.botones.cancelar'),
							'clase': 'btn-danger',
							'accion': function accion() {
								sacarUltimo();
								diferido.reject();
							}
						}
					}
				};
				agregarNodoPila('confirmacion', data, otros);
			});
			return diferido.promise();
		};

		var agregarNodoPila = function agregarNodoPila(ID, data, otroMapa) {
			var nodo = $(data);
			$('body').append(nodo);
			pilaLocal.push({ 'id': ID, 'nodo': nodo });
			activarNodo(nodo, otroMapa);
		};

		var mostrarMenuBasico = function mostrarMenuBasico() {
			var ID = 'menu';
			var diferido = $.Deferred();
			if (esUltimoId(ID)) {
				sacarUltimo();
				diferido.reject();
				return diferido.promise();
			}
			var promesa = null;
			if (moduloApp.esUsuario()) {
				if (moduloApp.esAdmin()) {
					promesa = cargarHtml('/menuInicialAdmin.html');
				} else {
					promesa = cargarHtml('/menuInicialAnonimo.html');
				}
			} else {
				promesa = cargarHtml('/menuInicialAnonimo.html');
			}
			$.when(promesa).then(function (data) {
				agregarNodoPila(ID, data);
				diferido.resolve();
			});
			return diferido.promise();
		};

		var mostrarMenuPagina = function mostrarMenuPagina() {
			//TODO reconfigurar
			pila.push('menu_pagina');
			$('.menu_core').toggleClass('invisible');
			$('.menu_pagina').toggleClass('invisible');
			window.scrollTo(0, 0);
		};

		var mostrarFormularioEdicion = function mostrarFormularioEdicion(nodo, atributo, valor, sufijo) {
			//TODO reconfigurar
			$(".formhtml").attr('nodo2', nodo);
			$(".formhtml").attr('property2', atributo);
			$(".formhtml").attr('sufijo', sufijo);
			$('.formhtml textarea').val(valor);
			$('.formhtml').removeClass('invisible');
		};

		var inicializar = function inicializar() {
			var diferido = $.Deferred();
			$(document).keyup(function (e) {
				if (e.keyCode == 27) {
					esconderPropiedadesDePagina();
					if (pilaLocal.length == 0) {
						mostrarMenuBasico();
					} else {
						sacarUltimo();
					}
				}
			});
			diferido.resolve();
			return diferido.promise();
		};

		return {
			'inicializar': inicializar,
			'mostrarMenuPagina': mostrarMenuPagina,
			'mostrarFormularioEdicion': mostrarFormularioEdicion,
			'mostrarMenuBasico': mostrarMenuBasico,
			'mostrarMenuSoloTexto': mostrarMenuSoloTexto,
			'confirmar': confirmar,
			'sacarUltimo': sacarUltimo,
			'error': error,
			'info': info
		};
	}();
}

var moduloHistoria = function () {
	var OFFSET_VISIBLE = 0; //Porcentaje de la altura de la ventana
	var ALTO = $(window).height();
	var ANCHO = $(window).width();

	var EXPRESION = '(\\s*|\\d|(maxx)|(maxy)|\\*|-|\\+|\\.)+';
	var EXPRESIONSE = '(\\d|(maxx)|(maxy)|\\*|-|\\+|\\.)+'; //No acepta espacios
	var DOSCAMPOS = '\\(\\s*(' + EXPRESION + ')\\s*(px)?\\s*,\\s*(' + EXPRESION + ')(px)?\\s*\\)';
	var DOSCAMPOSNP = '(' + EXPRESIONSE + ')\\s*(px)?\\s*(' + EXPRESIONSE + ')(px)?';
	var UNCAMPO = '\\(\\s*(' + EXPRESION + ')\\s*(deg|rad|px)?\\s*\\)';
	var UNCAMPONP = '(' + EXPRESIONSE + ')\\s*(deg|rad|px)?';
	var TRANSFORM = '[^;]?\\s*transform\\s*:.*?';

	var PATRONES = {
		'translate': {
			'p': new RegExp('(' + TRANSFORM + 'translate\\s*' + DOSCAMPOS + ')', 'ig'),
			'borrar': new RegExp('(translate\\s*' + DOSCAMPOS + ')', 'ig'),
			'defs': ['transform', '-ms-transform', '-webkit-transform'],
			'grupos': [2, 7],
			'par': true,
			'pre': 'translate',
			'sep': ',',
			'uni': 'px' //Siempre se interpretará en px
		},
		'btranslate': {
			'p': new RegExp('(background-position\\s*:\\s*' + DOSCAMPOSNP + '\\s*[;$])', 'ig'),
			'borrar': new RegExp('(background-position\\s*:\\s*' + DOSCAMPOSNP + '\\s*[;$])', 'ig'),
			'defs': ['background-position'],
			'grupos': [2, 7],
			'par': false,
			'pre': '',
			'sep': ' ',
			'uni': 'px'
		},
		'rotate': {
			'p': new RegExp('(' + TRANSFORM + 'rotate\\s*' + UNCAMPO + ')', 'ig'),
			'borrar': new RegExp('(rotate\\s*' + UNCAMPO + ')', 'ig'),
			'defs': ['transform', '-ms-transform', '-webkit-transform'],
			'grupos': [2],
			'par': true,
			'pre': 'rotate',
			'sep': ' ',
			'uni': 'deg'
		},
		'scale1': {
			'p': new RegExp('(' + TRANSFORM + 'scale\\s*' + UNCAMPO + ')', 'ig'),
			'borrar': new RegExp('(scale\\s*' + UNCAMPO + ')', 'ig'),
			'defs': ['transform', '-ms-transform', '-webkit-transform'],
			'grupos': [2],
			'par': true,
			'pre': 'scale',
			'sep': ' ',
			'uni': ''
		},
		'scale2': {
			'p': new RegExp('(' + TRANSFORM + 'scale\\s*' + DOSCAMPOS + ')', 'ig'),
			'borrar': new RegExp('(scale\\s*' + DOSCAMPOS + ')', 'ig'),
			'defs': ['transform', '-ms-transform', '-webkit-transform'],
			'grupos': [2, 7],
			'par': true,
			'pre': 'scale',
			'sep': ',',
			'uni': ''
		},
		'bscale1': {
			'p': new RegExp('(background-size\\s*:\\s*' + UNCAMPONP + '\\s*[;$])', 'ig'),
			'borrar': new RegExp('(background-size\\s*:\\s*' + UNCAMPONP + '\\s*[;$])', 'ig'),
			'defs': ['background-size', '-webkit-background-size', '-moz-background-size', '-o-background-size'],
			'grupos': [2],
			'par': false,
			'pre': '',
			'sep': ' ',
			'uni': 'px'
		},
		'bscale2': {
			'p': new RegExp('(background-size\\s*:\\s*' + DOSCAMPOSNP + '\\s*[;$])', 'ig'),
			'borrar': new RegExp('(background-size\\s*:\\s*' + DOSCAMPOSNP + '\\s*[;$])', 'ig'),
			'defs': ['background-size'],
			'grupos': [2, 7],
			'par': false,
			'pre': '',
			'sep': ' ',
			'uni': 'px'
		}
	};

	var inicializar = function inicializar() {
		//1. Se itera el dom buscando la clase principal
		$('.mostrar-historia').each(function (i, elem) {
			var jelem = $(elem);
			if (jelem.data('ok') !== true) {
				//Se asegura que se itere solo una vez

				//Se esconden los demás hijos
				var hijos = jelem.children();
				hijos.addClass('invisible');

				var OFFSET = jelem.attr('data-historia-offset');
				if (!esNumero(OFFSET)) {
					OFFSET = 0;
				}

				var leerGrupos = function leerGrupos(todo, grupos) {
					var ans = [];
					for (var _i = 0; _i < grupos.length; _i++) {
						var temp = todo[grupos[_i]];
						temp = temp.replace(/maxx/ig, ANCHO);
						temp = temp.replace(/maxy/ig, ALTO);
						try {
							temp = eval(temp);
							ans.push(temp);
						} catch (e) {
							console.log('No se pudo evaluar:', temp);
						}
					}
					return ans;
				};

				var procesarExpresion = function procesarExpresion(patron, estilo) {
					patron.p.lastIndex = 0;
					var m;
					var ans = null;
					do {
						m = patron.p.exec(estilo);
						if (m) {
							ans = leerGrupos(m, patron.grupos);
						}
					} while (m);
					return ans;
				};

				var procesarEstilo = function procesarEstilo(jelem) {

					var estilo = jelem.attr('style');
					if (hayValor(estilo)) {
						var metadata = {};
						for (var llavePatron in PATRONES) {
							var unPatron = PATRONES[llavePatron];
							var calculado = procesarExpresion(unPatron, estilo);
							if (hayValor(calculado)) {
								unPatron.borrar.lastIndex = 0;
								estilo = estilo.replace(unPatron.borrar, '');
								metadata[llavePatron] = calculado;
							}
						}
						estilo = estilo.replace(new RegExp('transform\\s*:.*?[;$]', 'ig'), '');
						jelem.attr('style', estilo);
						//console.log('estilo final:', estilo);
						//console.log(JSON.stringify(metadata));
						jelem.data('pinterpol', metadata);
					}
				};

				//Se pre-procesan los estilos
				hijos.each(function (i, elem) {
					var jelem = $(elem);
					procesarEstilo(jelem);
				});

				//Se clona el primer hijo
				var pHijo = jelem.children(":first").clone();
				var tipoHijo = pHijo[0].tagName;

				//Se agrega
				jelem.append(pHijo);
				//Solo se muestra el primer hijo
				pHijo.removeClass('invisible');

				jelem.data('darIndicePonderado', function (ponderacion) {
					var ans = parseInt(ponderacion * (hijos.length - OFFSET));
					if (ans < 0) {
						ans = 0;
					}
					if (ans >= hijos.length) {
						ans = hijos.length - 1;
					}
					return ans;
				});

				jelem.data('darSubPonderado', function (indice, ponderacion) {
					var tam = hijos.length - OFFSET;
					var ans = (ponderacion - indice / tam) * tam;
					if (ans > 1) {
						ans = 1;
					}
					return ans;
				});

				//Se agrega la función de actualización
				jelem.data('act', function (datos) {
					var internos = {
						'pos': jelem.offset(),
						'altura': jelem.height()
					};
					internos.ymin = internos.pos.top;
					internos.ymax = internos.pos.top + internos.altura;
					//1. Se mira si está visible
					internos.vExtSup = internos.ymin >= datos.ymin && internos.ymin <= datos.ymax;
					internos.vExtInf = internos.ymax >= datos.ymin && internos.ymax <= datos.ymax;
					internos.vis = internos.vExtInf || internos.vExtSup;

					var ext1 = internos.ymin - datos.alturaVentana - datos.offset;
					var ext2 = internos.ymax - datos.offset;
					var modo = 0;
					if (modo == 0) {
						//Desde que aparece
						internos.p2 = ponderar(datos.scroll, ext1, ext2);
					} else if (modo == 1) {
						//Solo cuando está todo visible
						internos.p2 = ponderar(datos.scroll, ext1 + internos.altura, ext2 - internos.altura);
					}
					internos.p2Inv = 1 - internos.p2;
					internos.i2 = jelem.data('darIndicePonderado')(internos.p2);

					//Se calcula el hijo ponderado
					var hijoPonderado = $(hijos[internos.i2]);
					internos.i2sp = jelem.data('darSubPonderado')(internos.i2, internos.p2);
					internos.i2spInv = 1 - internos.i2sp;

					//console.log(internos.p2, internos.i2, internos.i2sp);
					//Se aplican los estilos del hijo ponderado
					var estiloPonderado = hijoPonderado.attr('style');
					var estadoActual = {};
					var datos1 = hijoPonderado.data('pinterpol');
					if (internos.i2 < hijos.length - 1) {
						var hijoPonderadoAnterior = $(hijos[internos.i2 + 1]);
						var datos2 = hijoPonderadoAnterior.data('pinterpol');
						//Se generan los estilos interpolados
						for (var llavePatron in datos2) {
							var datoActual = datos2[llavePatron];
							var datoAnterior = datos1[llavePatron];
							if (hayValor(datoActual)) {
								if (hayValor(datoAnterior)) {
									//Se interpola
									estadoActual[llavePatron] = [];
									for (var k = 0; k < datoActual.length; k++) {
										estadoActual[llavePatron][k] = parseInt(datoActual[k] * internos.i2sp + datoAnterior[k] * internos.i2spInv);
									}
								} else {
									//No se interpola
									estadoActual[llavePatron] = copiarJSON(datoActual);
								}
							}
						}
					} else {
						//Se debe aplicar los estilos del único actual
						estadoActual = copiarJSON(datos1);
					}
					var mapaFinal = {};
					//1. Se agrupan
					for (var _llavePatron in estadoActual) {
						var unPatron = PATRONES[_llavePatron];
						var lista = estadoActual[_llavePatron];
						for (var j = 0; j < lista.length; j++) {
							lista[j] = lista[j] + unPatron.uni;
						}
						for (var m = 0; m < 1; m++) {
							//unPatron.defs.length
							var estiloNom = unPatron.defs[m];
							if (!(estiloNom in mapaFinal)) {
								mapaFinal[estiloNom] = [];
							}
							var temp = lista.join(unPatron.sep);
							if (unPatron.par) {
								temp = '(' + temp + ')';
							}
							mapaFinal[estiloNom].push(unPatron.pre + temp);
						}
					}

					//2. Se generan los estilos
					for (var llaveEstilo in mapaFinal) {
						var nuevoEstilo = ' ';
						var subMapa = mapaFinal[llaveEstilo];
						nuevoEstilo += llaveEstilo + ': ';
						for (var _m = 0; _m < subMapa.length; _m++) {
							nuevoEstilo += subMapa[_m] + ' ';
						}
						estiloPonderado += nuevoEstilo + ';';
					}

					pHijo.attr('style', estiloPonderado);

					//Se aplican todas las clases del hijo excepto la de invisible
					var clasesPonderadas = hijoPonderado.attr('class');
					pHijo.attr('class', clasesPonderadas);
					pHijo.removeClass('invisible');

					//Se pasa el texto ponderado
					pHijo.html(hijoPonderado.html());

					//Se pasa la fuente de la imagen
					if (tipoHijo == 'IMG') {
						pHijo.attr('src', hijoPonderado.attr('src'));
					}

					//jelem.find('.hdebug').text(JSON.stringify(internos));
				});

				jelem.data('ok', true);
			}
		});

		$(window).on("scroll resize", refrescar);
	};

	//ext2 debe ser mayor que ext1
	var ponderar = function ponderar(val, ext1, ext2) {
		if (ext1 >= ext2) {
			return 0;
		}
		if (val < ext1) {
			return 0;
		}
		if (val > ext2) {
			return 1;
		}
		return (val - ext1) / (ext2 - ext1);
	};

	var refrescar = function refrescar() {
		var datos = {
			'scroll': $(window).scrollTop(),
			'alturaVentana': $(window).height()
			//'alturaDocumento': $( document ).height(),
		};
		datos.offset = parseInt(datos.alturaVentana * OFFSET_VISIBLE);
		datos.ymin = datos.scroll + datos.offset;
		datos.ymax = datos.scroll + datos.alturaVentana - datos.offset;
		$('.mostrar-historia').each(function (i, elem) {
			var jelem = $(elem);
			if (typeof jelem.data('act') === 'function') {
				jelem.data('act')(datos);
			}
		});
	};

	$(document).ready(function () {
		inicializar();
		refrescar();
	});

	return {
		'inicializar': inicializar
	};
}();

if (!hayValor(moduloJuegoVista)) {

	//Responde: ¿cuántas personas eligieron una pregunta dada?
	var totalizarSumaRespuestas = function totalizarSumaRespuestas(metadata) {
		var totales = {};
		if (hayValor(metadata.jugadores)) {
			var llavePregunta = metadata.idPregunta;
			var respuestas = metadata.preguntaActual.respuestas;
			var llavesRespuestas = Object.keys(respuestas);
			$.each(metadata.jugadores, function (jugador, unJugador) {
				//Se cruza cada jugador con la elección
				if (hayValor(unJugador.respuestas)) {
					var eleccion = unJugador.respuestas[llavePregunta];
					if (hayValor(eleccion)) {
						if (estaEnLista('' + eleccion, llavesRespuestas)) {
							if (!esNumero(totales[eleccion])) {
								totales[eleccion] = 1;
							} else {
								totales[eleccion] += 1;
							}
						}
					}
				}
			});
		}
		return totales;
	};

	var regenerarPuntajes = function regenerarPuntajes(datos) {
		console.log('regenerarPuntajes');
		if (hayValor(datos.jugadores)) {
			$.each(datos.jugadores, function (jugador, unJugador) {
				//Se cruza cada jugador con los puntajes
				unJugador.puntos = 0;
				if (hayValor(unJugador.respuestas)) {
					$.each(unJugador.respuestas, function (llavePregunta, valorRespuesta) {
						if (hayValor(datos.juego.preguntas[llavePregunta])) {
							var posibles = datos.juego.preguntas[llavePregunta].respuestas;
							if (hayValor(posibles[valorRespuesta])) {
								unJugador.puntos += parseInt(posibles[valorRespuesta].puntos);
							}
						}
					});
				}
			});
		}
	};

	var pluginsModuloVistaJuego = {
		'score': {
			boton: { icono: 'fa-star', color: 'btn-default' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/score.html',
					'funInicio': function funInicio(plantilla) {
						regenerarPuntajes(metadata);
						return $(plantilla);
					},
					'lista': metadata.jugadores,
					'funIter': function funIter(plantilla, i, llave, unJugador) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(unJugador.apodo));
						plantilla = plantilla.replace('$2', unJugador.puntos);
						var nuevo = $(plantilla);
						nuevo.find('.abc-chao').on('click', function () {
							metadata.moduloJuego.borrarJugador(llave);
						});
						return nuevo;
					},
					'funOrdenar': function funOrdenar(a, b) {
						return a.puntos - b.puntos;
					}
				};
			}
		},
		'reloj': {
			boton: { icono: 'fa-clock-o', color: 'btn-danger' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/reloj.html',
					'recargarHtml': false,
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(metadata.preguntaActual.texto));
						return $(plantilla);
					},
					'funFinalizar': function funFinalizar() {
						var elTimer = moduloTimer($('div.timer'));
						var segundos = leerObj(metadata, 'preguntaActual.segundos', 10);
						var promesa = elTimer.iniciar(segundos);
						metadata.moduloJuego.publicarJuego();
						$.when(promesa).then(function () {
							metadata.moduloJuego.terminarJuego();
						});
					}
				};
			}
		},
		'historia': {
			boton: { icono: 'fa-question', color: 'btn-info' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/historia.html',
					'recargarHtml': false,
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', metadata.preguntaActual.href);
						plantilla = plantilla.replace('$3', darHtmlSeguro(metadata.preguntaActual.respuesta));
						return $(plantilla);
					},
					'lista': metadata.preguntaActual.respuestas,
					'funFinalizar': function funFinalizar() {
						$('.mi-boton-final').on('click', function () {
							if (esFuncion(metadata.moduloJuego.usuarioEligeRespuesta)) {
								metadata.moduloJuego.usuarioEligeRespuesta();
							}
						});
					},
					'funIter': function funIter(plantilla, i, llave, elemento) {
						plantilla = plantilla.replace('$2', darHtmlSeguro(elemento.texto));
						plantilla = plantilla.replace('$4', i);
						var nuevo = $(plantilla);
						var miInput = nuevo.find('input')[0];
						var funcionFinal = function funcionFinal() {
							//Hacer exluyentes las demás
							nuevo.parent().find('input').each(function (i, elem) {
								if (elem != miInput) {
									elem.checked = false;
								}
							});
							//Mostrar el botón del final si hay al menos una opción
							var tam = nuevo.parent().find('input:checked').length;
							if (tam == 0) {
								$('.mi-boton-final').addClass('invisible');
							} else {
								metadata.moduloJuego.usuarioTomaRespuesta(llave, elemento, nuevo, metadata.preguntaActual.id);
								$('.mi-boton-final').removeClass('invisible');
							}
						};
						nuevo.on('click', funcionFinal);
						nuevo.click(funcionFinal);
						return nuevo;
					}
				};
			}
		},
		'pregunta': {
			boton: { icono: 'fa-question', color: 'btn-info' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/pregunta.html',
					'recargarHtml': false,
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(metadata.preguntaActual.texto));
						plantilla = plantilla.replace('$3', darHtmlSeguro(metadata.preguntaActual.respuesta));
						return $(plantilla);
					},
					'lista': metadata.preguntaActual.respuestas,
					'funIter': function funIter(plantilla, i, llave, elemento) {
						plantilla = plantilla.replace('$2', darHtmlSeguro(elemento.texto));
						var nuevo = $(plantilla);
						nuevo.find('.panel-body').css('background-color', elemento.color);
						var funcionFinal = function funcionFinal() {
							if (esFuncion(metadata.moduloJuego.usuarioEligeRespuesta)) {
								metadata.moduloJuego.usuarioEligeRespuesta(llave, elemento, nuevo, metadata.preguntaActual.id);
							}
						};
						nuevo.on('doubletap', funcionFinal);
						nuevo.dblclick(funcionFinal);
						return nuevo;
					}
				};
			}
		},
		'blanco': {
			boton: null,
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/blanco.html',
					'recargarHtml': true,
					'funInicio': function funInicio(plantilla) {
						return $(plantilla);
					}
				};
			}
		},
		'respuesta': {
			boton: { icono: 'fa-check', color: 'btn-primary' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/respuesta.html',
					'recargarHtml': false,
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(metadata.preguntaActual.respuesta));
						return $(plantilla);
					}
				};
			}
		},
		'barras': {
			boton: { icono: 'fa-bar-chart', color: 'btn-danger' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/barras.html',
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(metadata.preguntaActual.texto));
						return $(plantilla);
					},
					'recargarHtml': false,
					'funFinalizar': function funFinalizar() {
						//1. Se crea la data
						if (!hayValor(metadata.data)) {
							metadata.data = {
								labels: [],
								datasets: [{
									label: "# de Personas",
									backgroundColor: "rgba(255,99,132,0.2)",
									borderColor: "rgba(255,99,132,1)",
									borderWidth: 2,
									hoverBackgroundColor: "rgba(255,99,132,0.4)",
									hoverBorderColor: "rgba(255,99,132,1)",
									data: []
								}]
							};
						}

						metadata.data.labels = [];
						metadata.data.datasets[0].data = [];

						var totales = totalizarSumaRespuestas(metadata);

						$.each(metadata.preguntaActual.respuestas, function (llave, valor) {
							metadata.data.labels.push(valor.texto);
							if (esNumero(totales[llave])) {
								metadata.data.datasets[0].data.push(totales[llave]);
							} else {
								metadata.data.datasets[0].data.push(0);
							}
						});

						//2. Se crean las opciones
						if (!hayValor(metadata.chart)) {
							var options = {
								responsive: true,
								legend: { position: 'top' },
								maintainAspectRatio: false,
								scales: {
									yAxes: [{
										stacked: true,
										gridLines: {
											display: true,
											color: "rgba(255,99,132,0.2)"
										}
									}],
									xAxes: [{
										gridLines: {
											display: false
										}
									}]
								}
							};
							//Se inicializar el chart
							metadata.chart = Chart.Bar('chart', {
								options: options,
								data: metadata.data
							});
						} else {
							metadata.chart.update();
						}
					}
				};
			}
		},
		'dona': {
			boton: { icono: 'fa-pie-chart', color: 'btn-danger' },
			programa: function programa(metadata) {
				return {
					'url': '/assets/cmgae/juego/modos/dona.html',
					'funInicio': function funInicio(plantilla) {
						plantilla = plantilla.replace('$1', darHtmlSeguro(metadata.preguntaActual.texto));
						return $(plantilla);
					},
					'recargarHtml': false,
					'funFinalizar': function funFinalizar() {
						//1. Se crea la data
						if (!hayValor(metadata.config)) {
							metadata.config = {
								type: 'doughnut',
								data: {
									datasets: [{
										data: [],
										backgroundColor: [],
										label: '# de Personas'
									}],
									labels: []
								},
								options: {
									responsive: true,
									legend: {
										position: 'top'
									},
									title: {
										display: true,
										text: ''
									},
									animation: {
										animateScale: true,
										animateRotate: true
									}
								}
							};
						}

						metadata.config.data.labels = [];
						metadata.config.data.datasets[0].data = [];

						var totales = totalizarSumaRespuestas(metadata);

						$.each(metadata.preguntaActual.respuestas, function (llave, valor) {
							metadata.config.data.labels.push(valor.texto);
							metadata.config.data.datasets[0].backgroundColor.push(valor.color);
							if (esNumero(totales[llave])) {
								metadata.config.data.datasets[0].data.push(totales[llave]);
							} else {
								metadata.config.data.datasets[0].data.push(0);
							}
						});

						//2. Se crean las opciones
						if (!hayValor(metadata.chart)) {
							var ctx = document.getElementById("chart-area").getContext("2d");
							metadata.chart = new Chart(ctx, metadata.config);
							//Se inicializar el chart
						} else {
							metadata.chart.update();
						}
					}
				};
			}
		}
	};

	var moduloJuegoVista = function moduloJuegoVista(jElem, jElemHead, juego, moduloJuego) {
		var datos = {
			elem: $(jElem),
			elemHead: $(jElemHead),
			juego: juego,
			jugadores: null,
			modo: null,
			idPregunta: null,
			preguntaActual: null,
			moduloJuego: moduloJuego,
			metadata: null,
			ultimaPlantilla: null,
			ultimaPregunta: null
		};

		var asignarModuloJuego = function asignarModuloJuego(moduloJuego) {
			datos.moduloJuego = moduloJuego;
		};

		var asignarPreguntaActual = function asignarPreguntaActual(idPregunta, preguntaActual) {
			datos.idPregunta = idPregunta;
			datos.preguntaActual = preguntaActual;
		};

		var botones = {};
		var modos = {};

		for (var llave in pluginsModuloVistaJuego) {
			var unPlugin = pluginsModuloVistaJuego[llave];
			botones[llave] = unPlugin.boton;
			modos[llave] = unPlugin.programa;
		}

		var actualizar = function actualizar() {
			var temp = modos[datos.modo](datos.metadata);
			if (hayValor(temp)) {
				remplazarContenido(temp);
			} else {
				//Solo borra todo
				datos.elem.empty();
			}
		};

		var asignarModo = function asignarModo(llave) {
			console.log('asignarModo', llave);
			if (!estaEnLista(llave, Object.keys(modos))) {
				return;
			}
			if (datos.modo !== llave) {
				//Se recrea la metadata
				datos.metadata = {};
			}
			datos.metadata['idPregunta'] = datos.idPregunta;
			datos.metadata['preguntaActual'] = datos.preguntaActual;
			datos.metadata['moduloJuego'] = datos.moduloJuego;
			datos.metadata['jugadores'] = datos.jugadores;
			datos.metadata['juego'] = datos.juego;

			datos.modo = llave;
			actualizar();
		};

		var asignarPrimerModo = function asignarPrimerModo() {
			console.log('asignarPrimerModo');
			asignarModo(Object.keys(datos.preguntaActual.vistas)[0]);
		};

		var asignarJugadores = function asignarJugadores(jugadores) {
			console.log('asignarJugadores', datos.modo);
			datos.jugadores = jugadores;
			//Pide actualizar el modo actual
			if (!hayValor(datos.modo)) {
				asignarPrimerModo();
			} else {
				asignarModo(datos.modo);
			}
		};

		var remplazarContenido = function remplazarContenido(props) {
			if (!hayValor(props.recargarHtml)) {
				props.recargarHtml = true;
			}

			var funcionDespues = function funcionDespues(plantilla, tieneContenido) {
				console.log('funcionDespues', tieneContenido);
				datos.ultimaPlantilla = props.url;
				datos.ultimaPregunta = datos.idPregunta;
				if (tieneContenido) {
					datos.elem.empty();
					if (esFuncion(props.funInicio)) {
						datos.elem.append(props.funInicio(plantilla, datos.metadata));
					} else {
						datos.elem.append($(plantilla));
					}
				}
				if (hayValor(props.lista)) {
					var listaValores = [];
					var llavesLlaves = [];
					$.each(props.lista, function (llaveLista, valorLista) {
						listaValores.push(valorLista);
						llavesLlaves.push(llaveLista);
					});
					if (esFuncion(props.funOrdenar)) {
						listaValores.sort(props.funOrdenar);
					}
					var repetido = datos.elem.find('.abc-repetir');
					if (repetido.length > 0) {
						repetido.removeClass('abc-repetir');
						repetido.removeClass('invisible');
						var plantilla = darHtmlCompleto(repetido);
						$.each(listaValores, function (i, unJugador) {
							var nuevo = props.funIter(plantilla, i, llavesLlaves[i], unJugador, datos.metadata);
							repetido.after(nuevo);
						});
						repetido.remove();
					}
				}

				var funcionEsperar = function funcionEsperar(i, elem2) {
					moduloActividad.on();
					var jelem = $(elem2);
					jelem.ready(function () {
						moduloActividad.off();
					});
				};

				//mira si se deben cargar htmls externos
				$('[data-incluir]').each(function (i, elem) {
					var jelem = $(elem);
					var incluirHref = jelem.attr('data-incluir');
					if (hayValor(incluirHref)) {
						var promesaIncluir = moduloHttp.get(incluirHref, true);
						promesaIncluir.then(function (contenidoIncluir) {
							jelem.html(contenidoIncluir);
							jelem.find('img,style,script,link').each(funcionEsperar);
							$('head').find('link').each(funcionEsperar);
							moduloHistoria.inicializar();
						});
					}
				});

				if (esFuncion(props.funFinalizar)) {
					props.funFinalizar(datos.metadata);
				}
			};

			if (props.recargarHtml == false && datos.ultimaPlantilla == props.url && datos.ultimaPregunta == datos.idPregunta) {
				funcionDespues(null, false);
			} else {
				var promesa = moduloHttp.get(props.url, true);
				promesa.then(function (plantilla) {
					funcionDespues(plantilla, true);
				});
			}
		};

		var generarBoton = function generarBoton(llave, config) {
			if (!hayValor(config)) {
				return null;
			}
			var boton = $('<button type="button" class="btn abc-jugar"><i class="fa" aria-hidden="true"></i></button>');
			boton.addClass(config.color);
			boton.find('i').addClass(config.icono);
			boton.on('click', function () {
				asignarModo(llave);
			});
			return boton;
		};

		var regenerarBotonesVista = function regenerarBotonesVista(pregunta) {
			datos.elemHead.empty();
			$.each(pregunta.vistas, function (llave, val) {
				var boton = generarBoton(llave, botones[llave]);
				if (hayValor(boton)) {
					datos.elemHead.append(boton);
				}
			});
		};

		//Va a una pregunta específica
		var irA = function irA(indice) {
			datos.idPregunta = datos.juego.orden[indice];
			datos.preguntaActual = datos.juego.preguntas[datos.idPregunta];
			$.each(datos.preguntaActual.respuestas, function (llave, valor) {
				valor.color = darColorAleatorio(180);
			});
			regenerarBotonesVista(datos.preguntaActual);
			asignarPrimerModo();
		};

		return {
			'asignarJugadores': asignarJugadores,
			'irA': irA,
			'asignarModo': asignarModo,
			'asignarPreguntaActual': asignarPreguntaActual,
			'asignarModuloJuego': asignarModuloJuego,
			'asignarPrimerModo': asignarPrimerModo,
			'actualizar': actualizar
		};
	};
}
if (!hayValor(moduloTimer)) {
	var moduloTimer = function moduloTimer(referencia) {
		var NOMBRE_DATA = 'moduloTimer';
		var refAnterior = referencia.data(NOMBRE_DATA);
		if (hayValor(refAnterior)) {
			return refAnterior;
		};

		var ESTADO = 0;
		var timer;
		var timerCurrent;
		var timerFinish;
		var timerSeconds;
		var diferido = null;

		//Asigna el timer en un valor dado
		var asignarPorcentaje = function asignarPorcentaje(percent) {
			referencia.html('<div class="percent"></div><div class="slice"' + (percent > 50 ? ' class="gt50"' : '') + '><div class="pie"></div>' + (percent > 50 ? '<div class="pie fill"></div>' : '') + '</div>');
			var deg = 360 / 100 * percent;
			referencia.find('.slice .pie').css({
				'-moz-transform': 'rotate(' + deg + 'deg)',
				'-webkit-transform': 'rotate(' + deg + 'deg)',
				'-o-transform': 'rotate(' + deg + 'deg)',
				'transform': 'rotate(' + deg + 'deg)'
			});
			var cuenta = timerSeconds * (100 - Math.round(percent)) / 100;
			referencia.find('.percent').text(parseInt(cuenta));

			if (percent > 50) {
				referencia.find('.slice').css({ position: 'inherit' });
			} else {
				referencia.find('.slice').css({ position: 'absolute' });
			}
		};

		var stopWatch = function stopWatch() {
			var seconds = (timerFinish - new Date().getTime()) / 1000;
			if (seconds <= 0) {
				asignarPorcentaje(100);
				clearInterval(timer);
				ESTADO = 0;
				diferido.resolve();
			} else {
				var percent = 100 - seconds / timerSeconds * 100;
				asignarPorcentaje(percent);
			}
		};

		var asingarTamanio = function asingarTamanio(pixeles) {
			referencia.css('font-size', pixeles + 'px');
		};

		var iniciar = function iniciar(segundos) {
			if (ESTADO == 0) {
				diferido = $.Deferred();
				ESTADO = 1;
				timerSeconds = segundos;
				timerCurrent = 0;
				timerFinish = new Date().getTime() + timerSeconds * 1000;
				timer = setInterval(stopWatch, 50);
			}
			return diferido.promise();
		};

		var toggle = function toggle(segundos) {
			if (ESTADO == 0) {
				iniciar();
			} else {
				ESTADO = 0;
				clearInterval(timer);
			}
			return diferido.promise();
		};

		referencia.data(NOMBRE_DATA, {
			'toggle': toggle,
			'asignarPorcentaje': asignarPorcentaje,
			'iniciar': iniciar
		});

		return referencia.data(NOMBRE_DATA);
	};
}