var hayValor=function(a){return void 0!=a&&null!=a&&(!("string"==typeof a)||a.trim().length>0)},esFuncion=function(a){return"function"==typeof a};if(!hayValor(moduloMenus))var moduloMenus=function(){var a=[],e=function(a){var e=$.Deferred();return moduloActividad.on(),$.ajax({url:"/assets/cmgae/menus"+a,type:"GET",cache:!1}).done(function(a){e.resolve(a)}).fail(function(){e.reject()}).always(function(){moduloActividad.off()}),e.promise()},o=function(e){return 0!=a.length&&a[a.length-1].id==e},n=function(){if(0!=a.length){a[a.length-1].nodo.remove(),a.pop()}},i=function(a){var o=e("/soloTexto.html");$.when(o).then(function(e){d("alerta",e,{html:{".mensaje_texto":a}})})},t=function(a){$.when(a).then(function(){i("Hecho!")},function(){i("Error :(")})},r=function(a,e){var o={funciones:{".menu_opc_ingresar":moduloApp.login,".menu_opc_salir":moduloApp.logout,".menu_opc_borrar_cache":moduloApp.borrarCache,".create-ui-toggle2":moduloApp.abrirBarraEdicion,".menuEliminar":moduloEdicion.funcElegirBorrar},html:{}};o=$.extend(o,e),$.each(o.funciones,function(e,o){a.find(e).on("click",function(){n();var a=o();hayValor(a)&&t(a)})});for(var i in o.html)a.find(i).html(o.html[i])},d=function(e,o,n){var i=$(o);$("body").append(i),a.push({id:e,nodo:i}),r(i,n)},c=function(){var a=$.Deferred();if(o("menu"))return n(),a.reject(),a.promise();var i=null;return i=e(moduloApp.esUsuario()?moduloApp.esAdmin()?"/menuInicialAdmin.html":"/menuInicialAnonimo.html":"/menuInicialAnonimo.html"),$.when(i).then(function(e){d("menu",e),a.resolve()}),a.promise()},l=function(){pila.push("menu_pagina"),$(".menu_core").toggleClass("invisible"),$(".menu_pagina").toggleClass("invisible"),window.scrollTo(0,0)},u=function(a,e,o,n){pila.push("formhtml"),console.log("mostrarFormularioEdicion",a,e,o),$(".formhtml").attr("nodo2",a),$(".formhtml").attr("property2",e),$(".formhtml").attr("sufijo",n),$(".formhtml textarea").val(o),$(".formhtml").removeClass("invisible")};return $(document).keyup(function(e){27==e.keyCode&&(0==a.length?c():n())}),{mostrarMenuPagina:l,mostrarFormularioEdicion:u,mostrarMenuBasico:c,mostrarMenuSoloTexto:i}}();if(!hayValor(moduloActividad))var moduloActividad=function(){var a=0;return{on:function(){0==a&&$("body").append('<div id="loading"><p>Procesando petici&oacute;n...</p></div>'),a++},off:function(){--a<=0&&(a=0,$("#loading").remove())}}}();if(!hayValor(moduloApp))var moduloApp=function(){var a={URL_LOGIN:URL_LOGIN,URL_LOGOUT:URL_LOGOUT,HAS_USER:HAS_USER,IS_ADMIN:IS_ADMIN},e=function(){return a.IS_ADMIN},o=function(){return a.HAS_USER},n=function(){window.location.href=a.URL_LOGIN},i=function(){window.location.href=a.URL_LOGOUT},t=function(){"full"===$("body").data("Midgard-midgardToolbar").options.display?($("body").data("Midgard-midgardToolbar").__proto__.hide(),$("body").data("Midgard-midgardToolbar").options.display="minimized"):($("body").data("Midgard-midgardToolbar").__proto__.show(),$("body").data("Midgard-midgardToolbar").options.display="full")};return{esAdmin:e,esUsuario:o,login:n,logout:i,borrarCache:function(){var a=$.Deferred();return moduloActividad.on(),$.ajax({type:"GET",url:"/act/clearmemcache",data:JSON.stringify({}),contentType:"application/json; charset=utf-8"}).done(function(e){a.resolve()}).fail(function(e,o){a.reject()}).always(function(){moduloActividad.off()}),a.promise()},abrirBarraEdicion:t}}();if(!hayValor(moduloArchivos))var moduloArchivos=function(){var a=function(a){var e={maximoTamanio:512e3,tipos:"image/*",auto:"true",dataFolder:"/imagenesbasico"};for(var o in e)hayValor(a[o])||(a[o]=e[o]);return a},e=function(e){var o=$.Deferred();e=a(e);var n=$('<input type="file" class="invisible" accept="'+e.tipos+'">');return n.on("change",function(a){var n=a.target.files[0];if(n.size>e.maximoTamanio)return alert("Archivo muy grande! debe ser menor a "+e.maximoTamanio/1024+" KB"),void o.reject();(new FileReader).readAsDataURL(n);var i=new FormData;i.append("file-0",n),i.append("folder",e.dataFolder),hayValor(e.id)&&i.append("name",e.id),"false"==e.auto&&i.append("auto","false"),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:i,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve(a)}).fail(function(){o.reject()}).always(function(){moduloActividad.off()})}),n.click(),o.promise()},o=function(a,e){var o=$.Deferred(),n={type:"text/plain"},i=new File([e],a,n),t=new FormData;return t.append("file-0",i),t.append("auto","false"),t.append("name",a),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:t,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve()}).fail(function(){o.reject()}).always(function(){moduloActividad.off()}),o.promise()};return{leerTextoPlano:function(a){var e=$.Deferred();return moduloActividad.on(),$.ajax({url:"/storage/read?name="+encodeURIComponent(a),type:"GET",cache:!1,contentType:!1,processData:!1}).done(function(a){e.resolve(a)}).fail(function(){e.reject()}).always(function(){moduloActividad.off()}),e.promise()},escribirTextoPlano:o,subirArchivo:e}}();if(!hayValor(moduloEditorTexto))var moduloEditorTexto=function(a){var e=function(){a.empty();var e=$("<div/>",{id:"pluginEditor"});a.append(e)},o=function(a){var e=ace.edit("pluginEditor"),o=moduloArchivos.escribirTextoPlano(a,e.getValue());$.when(o).then(function(){alert("Archivo guardado!")},function(){alert("Error subiendo el archivo")})};return{abrirEditor:function(a,n,i){var t=[{patron:/.*\.js/gi,editor:"ace/mode/javascript"},{patron:/.*\.html/gi,editor:"ace/mode/html"},{patron:/.*\.json/gi,editor:"ace/mode/json"},{patron:/.*\.css/gi,editor:"ace/mode/css"},{patron:/.*\.xml/gi,editor:"ace/mode/xml"}];e();var r=ace.edit("pluginEditor");r.setValue(n),r.setTheme("ace/theme/monokai"),r.commands.addCommand({name:"comandoGuardar",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(a){o(i)},readOnly:!0});for(var d=0;d<t.length;d++){var c=t[d];c.patron.test(a)&&r.getSession().setMode(c.editor)}},destruirEditor:e}};if(!hayValor(moduloArbolArchivos))var moduloArbolArchivos=function(a,e){var o=moduloEditorTexto(e);a.on("changed.jstree",function(a,e){if(e.selected.length){e.instance.get_node(e.selected[0])}}),a.on("rename_node.jstree",function(a,e){var o=(e.old,e.text),n=e.node;"folder"==n.original.type?e.instance.set_id(n,e.node.parent+o+"/"):e.instance.set_id(n,e.node.parent+o)}),a.on("load_node.jstree",function(a,e){for(var o=e.instance,i=0;i<e.node.children.length;i++){var t=e.node.children[i],r=o.get_node(t);n(r)}}),a.on("create_node.jstree",function(a,e){n(e.node)});var n=function(e){"file"==e.original.type&&a.jstree(!0).set_icon(e.id,"/assets/js/jstree/themes/default/file.png")},i=function(a){var e={separator_before:!1,separator_after:!1,label:"Abrir",action:function(a){o.destruirEditor();var e=$.jstree.reference(a.reference),n=e.get_node(a.reference),i=moduloArchivos.leerTextoPlano(n.id);$.when(i).then(function(a){"string"!=typeof a&&(a=""),o.abrirEditor(n.text,a,n.id)})}},n={separator_before:!1,separator_after:!1,label:"Crear carpeta",action:function(a){var e={text:"nuevo",type:"folder"},o=$.jstree.reference(a.reference),n=o.get_node(a.reference);o.create_node(n,e,"last",function(a){setTimeout(function(){o.edit(a)},0)})}},i={separator_before:!1,separator_after:!1,label:"Crear archivo",action:function(a){var e={text:"nuevo",type:"file"},o=$.jstree.reference(a.reference),n=o.get_node(a.reference);o.create_node(n,e,"last",function(a){setTimeout(function(){o.edit(a)},0)})}},t={separator_before:!1,separator_after:!1,label:"Renombrar",action:function(e){$.jstree.reference(e.reference).edit(a)}},r={separator_before:!1,separator_after:!1,label:"Borrar",action:function(e){console.log("borrar"),$.jstree.reference(e.reference).delete_node(a)}};return"folder"==a.original.type?{CrearArchivo:i,CrearCarpeta:n,Borrar:r}:"file"==a.original.type?{Abrir:e,Renombrar:t,Borrar:r}:void 0};return a.jstree({core:{check_callback:!0,themes:{stripes:!0},data:{url:function(a){return"/storage/jstreelist"},dataType:"json",data:function(a){return{id:a.id}}}},contextmenu:{items:i},plugins:["contextmenu","dnd","search","json_data","state","wholerow"]}),{}};if(!hayValor(moduloEdicion))var moduloEdicion=function(){var mapaIds={},activarEdicionOk=!1,activarEdicion=function(){!0===activarEdicionOk&&("undefined"!=typeof Backbone&&(Backbone.sync=function(a,e,o){try{var n=e.toJSON(),i=n["@subject"];e.isNew()&&(i in mapaIds?n["@subject"]=mapaIds[i]:(n["@subject"]="<"+(new Date).getTime()+"_"+Math.floor(10*Math.random()+1)+">",mapaIds[i]=n["@subject"]));var t=n["@subject"],r=n["@type"],d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(r),c=null;d&&(c=d[2]);var l=/(<)(.*)(>)/g,u=l.exec(t);if(null==u)return void o.error("error: no es identificador "+t);var s=u[2],f={};for(var m in n){var d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(m);d&&(f[d[2]]=n[m])}var p={};switch(p.payload=f,p.leng=LENGUAJE,a){case"create":case"update":moduloActividad.on(),$.ajax({type:"PUT",url:"/rest/"+(null===c||void 0===c?"Documento":c)+"/"+s,data:JSON.stringify(p),contentType:"application/json; charset=utf-8"}).done(function(a){o.success(e)}).fail(function(a,e){o.error("error")}).always(function(){moduloActividad.off()})}}catch(a){o.error("error "+a)}}),activarEdicionOk=!0)},activarPaginacion=function activarPaginacion(nodo){function activatePageA(actual){var cursor=actual.attr("data-next"),busqueda=JSON.parse(actual.attr("data-q")),template=actual.attr("data-tpl"),target=actual.attr("data-target"),ipage=parseInt(actual.attr("data-page"));busqueda.n||(busqueda.n=100),moduloApp.esAdmin()||actual.html(ipage*busqueda.n+1+" al "+(ipage+1)*busqueda.n),"1"===actual.attr("data-noa")&&(actual.removeAttr("href"),actual.on("click",function(){var docHtml=document.getElementById(template).innerHTML,destino=$(target),postload=destino.attr("data-postload");destino.length>0&&(moduloActividad.on(),$.ajax({type:"PUT",url:"/paginar/",data:JSON.stringify({busqueda:busqueda,cursor:cursor}),contentType:"application/json; charset=utf-8"}).done(function(msg){var datos=msg.datos,sigui=msg.next;destino.empty();for(var i=0;i<datos.length;i++){var dato=datos[i],nuevo=$(docHtml);llenarTemplate(nuevo,dato),destino.append(nuevo)}if(void 0!==sigui&&sigui.length>0){var padrePaginacion=actual.closest(".paginacion");if(0==padrePaginacion.find("[data-next='"+sigui+"']").length){for(var padreLocal=actual.parent(),nombreTAG=padreLocal.prop("tagName"),cambio=!1;padreLocal.get(0)!=padrePaginacion.get(0)&&"BODY"!=nombreTAG;)cambio=!0,actual=padreLocal,padreLocal=padreLocal.parent(),nombreTAG=padreLocal.prop("tagName");var paginaSigui=actual.clone(),paginaSigui2;paginaSigui2=cambio?paginaSigui.find("[data-next]"):paginaSigui,paginaSigui2.attr("data-page",ipage+1),paginaSigui2.attr("data-next",sigui),padrePaginacion.append(paginaSigui),activatePageA(paginaSigui2)}}void 0!==postload&&eval(postload)}).fail(function(a,e){moduloMenus.mostrarMenuSoloTexto("Error paginando")}).always(function(){moduloActividad.off()}))}))}hayValor(nodo)||(nodo=$("body")),nodo.find("a[data-next]").each(function(a,e){activatePageA($(e))})},funcElegirBorrar=function(){var a=$(".btnEliminar");a.length>0?a.remove():$("[about]").each(function(a){var e=$(this),o=e.find(".btnEliminar");if(0==o.length){e.prepend($('<div class="btnEliminar"><div class="btnEliminarX btnEliminar2 manito"></div><div class="btnEliminarX opciones invisible">\t<div class="btnEliminar3"></div>\t<div class="btnEliminar4 manito">Cancelar</div>\t<div class="btnEliminar5 manito">Aceptar</div></div></div>')),o=e.find(".btnEliminar");var n=o.find(".btnEliminar2"),i=o.find(".btnEliminar4"),t=o.find(".btnEliminar5");n.click(function(){var a=$(this);a.addClass("invisible"),a.siblings(".opciones").removeClass("invisible")}),t.click(function(){var a=$(this),e=a.closest("[about]");if(e.length>0){var o=e.attr("about"),n=null;n=e.attr("typeof");var i=(null===n||void 0===n?"":n)+"_"+o;i in mapaIds&&(o=mapaIds[i]),moduloActividad.on(),$.ajax({type:"DELETE",url:"/rest/"+(null===n||void 0===n?"":n)+"/"+o}).done(function(a){e.remove(),$("body").data("Midgard-midgardNotifications").create({body:JSON.stringify(a)}),location.reload()}).fail(function(a,e){$("body").data("Midgard-midgardNotifications").create({body:TRADUCTOR.error_ajax[LENGUAJE]})}).always(function(){moduloActividad.off()})}}),i.click(function(){var a=$(this);a.closest(".opciones").addClass("invisible"),a.closest(".btnEliminar").find(".btnEliminar2").removeClass("invisible")})}}),"menu"===pila[pila.length-1]&&pila.pop()};return activarPaginacion(),{activarPaginacion:activarPaginacion,activarEdicion:activarEdicion,funcElegirBorrar:funcElegirBorrar}}();$(function(){$("#paginaCompleta").enhsplitter({minSize:60,vertical:!1,position:60}),$("#totalArchivos").enhsplitter({minSize:60,position:350}),moduloArbolArchivos($("#contenedorArchivos"),$("editorTexto"))});