var hayValor=function(e){return void 0!=e&&null!=e&&(!("string"==typeof e)||e.trim().length>0)},moduloActividad=function(){var e=0;return{on:function(){0==e&&$("body").append('<div id="loading"><p>Procesando petici&oacute;n...</p></div>'),e++},off:function(){--e<=0&&(e=0,$("#loading").remove())}}}(),moduloArchivos=function(){var e=function(e){var r={maximoTamanio:512e3,tipos:"image/*",auto:"true",dataFolder:"/imagenesbasico"};for(var o in r)hayValor(e[o])||(e[o]=r[o]);return e},r=function(r){var o=$.Deferred();r=e(r);var t=$('<input type="file" class="invisible" accept="'+r.tipos+'">');return t.on("change",function(e){var t=e.target.files[0];if(t.size>r.maximoTamanio)return alert("Archivo muy grande! debe ser menor a "+r.maximoTamanio/1024+" KB"),void o.reject();(new FileReader).readAsDataURL(t);var n=new FormData;n.append("file-0",t),n.append("folder",r.dataFolder),hayValor(r.id)&&n.append("name",r.id),"false"==r.auto&&n.append("auto","false"),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:n,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(e){0!=e.error?o.reject():o.resolve(e)}).fail(function(){o.reject()}).always(function(){moduloActividad.off()})}),t.click(),o.promise()},o=function(e,r){var o=$.Deferred(),t={type:"text/plain"},n=new File([r],e,t),a=new FormData;return a.append("file-0",n),a.append("auto","false"),a.append("name",e),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:a,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(e){0!=e.error?o.reject():o.resolve()}).fail(function(){o.reject()}).always(function(){moduloActividad.off()}),o.promise()};return{leerTextoPlano:function(e){var r=$.Deferred();return moduloActividad.on(),$.ajax({url:"/storage/read?name="+encodeURIComponent(e),type:"GET",cache:!1,contentType:!1,processData:!1}).done(function(e){r.resolve(e)}).fail(function(){r.reject()}).always(function(){moduloActividad.off()}),r.promise()},escribirTextoPlano:o,subirArchivo:r}}(),moduloEditorTexto=function(e){var r=function(){e.empty();var r=$("<div/>",{id:"pluginEditor"});e.append(r)},o=function(e){var r=ace.edit("pluginEditor"),o=moduloArchivos.escribirTextoPlano(e,r.getValue());$.when(o).then(function(){alert("Archivo guardado!")},function(){alert("Error subiendo el archivo")})};return{abrirEditor:function(e,t,n){var a=[{patron:/.*\.js/gi,editor:"ace/mode/javascript"},{patron:/.*\.html/gi,editor:"ace/mode/html"},{patron:/.*\.json/gi,editor:"ace/mode/json"},{patron:/.*\.css/gi,editor:"ace/mode/css"},{patron:/.*\.xml/gi,editor:"ace/mode/xml"}];r();var i=ace.edit("pluginEditor");i.setValue(t),i.setTheme("ace/theme/monokai"),i.commands.addCommand({name:"comandoGuardar",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){o(n)},readOnly:!0});for(var d=0;d<a.length;d++){var c=a[d];c.patron.test(e)&&i.getSession().setMode(c.editor)}},destruirEditor:r}},moduloArbolArchivos=function(e,r){var o=moduloEditorTexto(r);e.on("changed.jstree",function(e,r){if(r.selected.length){r.instance.get_node(r.selected[0])}}),e.on("rename_node.jstree",function(e,r){var o=(r.old,r.text),t=r.node;"folder"==t.original.type?r.instance.set_id(t,r.node.parent+o+"/"):r.instance.set_id(t,r.node.parent+o)}),e.on("load_node.jstree",function(r,o){for(var t=o.instance,n=0;n<o.node.children.length;n++){var a=o.node.children[n];"file"==t.get_node(a).original.type&&e.jstree(!0).set_icon(a,"/assets/js/jstree/themes/default/file.png")}});var t=function(e){var r={separator_before:!1,separator_after:!1,label:"Abrir",action:function(e){o.destruirEditor();var r=$.jstree.reference(e.reference),t=r.get_node(e.reference),n=moduloArchivos.leerTextoPlano(t.id);$.when(n).then(function(e){"string"!=typeof e&&(e=""),o.abrirEditor(t.text,e,t.id)})}},t={separator_before:!1,separator_after:!1,label:"Crear carpeta",action:function(e){var r={text:"nuevo",type:"folder"},o=$.jstree.reference(e.reference),t=o.get_node(e.reference);o.create_node(t,r,"last",function(e){setTimeout(function(){o.edit(e)},0)})}},n={separator_before:!1,separator_after:!1,label:"Crear archivo",action:function(e){var r={text:"nuevo",type:"file"},o=$.jstree.reference(e.reference),t=o.get_node(e.reference);o.create_node(t,r,"last",function(e){setTimeout(function(){o.edit(e)},0)})}},a={separator_before:!1,separator_after:!1,label:"Renombrar",action:function(r){$.jstree.reference(r.reference).edit(e)}},i={separator_before:!1,separator_after:!1,label:"Borrar",action:function(r){console.log("borrar"),$.jstree.reference(r.reference).delete_node(e)}};return"folder"==e.original.type?{CrearArchivo:n,CrearCarpeta:t,Borrar:i}:"file"==e.original.type?{Abrir:r,Renombrar:a,Borrar:i}:void 0};return e.jstree({core:{check_callback:!0,themes:{stripes:!0},data:{url:function(e){return"/storage/jstreelist"},dataType:"json",data:function(e){return{id:e.id}}}},contextmenu:{items:t},plugins:["contextmenu","dnd","search","json_data","state","wholerow"]}),{}};$(function(){$("#paginaCompleta").enhsplitter({minSize:60,vertical:!1,position:60}),$("#totalArchivos").enhsplitter({minSize:60,position:350}),moduloArbolArchivos($("#contenedorArchivos"),$("editorTexto"))});