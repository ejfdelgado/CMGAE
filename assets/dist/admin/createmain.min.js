var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},hayValor=function(t){return void 0!=t&&null!=t&&(!("string"==typeof t)||t.trim().length>0)},moduloActividad=function(){var t=0;return{on:function(){0==t&&$("body").append('<div id="loading"><p>Procesando petici&oacute;n...</p></div>'),t++},off:function(){--t<=0&&(t=0,$("#loading").remove())}}}(),moduloArchivos=function(){var t=function(t){var a={maximoTamanio:512e3,tipos:"image/*",auto:"true",dataFolder:"/imagenesbasico"};for(var e in a)hayValor(t[e])||(t[e]=a[e]);return t},a=function(a){var e=$.Deferred();a=t(a);var r=$('<input type="file" class="invisible" accept="'+a.tipos+'">');return r.on("change",function(t){var r=t.target.files[0];if(r.size>a.maximoTamanio)return alert("Archivo muy grande! debe ser menor a "+a.maximoTamanio/1024+" KB"),void e.reject();(new FileReader).readAsDataURL(r);var o=new FormData;o.append("file-0",r),o.append("folder",a.dataFolder),hayValor(a.id)&&o.append("name",a.id),"false"==a.auto&&o.append("auto","false"),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:o,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(t){0!=t.error?e.reject():e.resolve(t)}).fail(function(){e.reject()}).always(function(){moduloActividad.off()})}),r.click(),e.promise()},e=function(t,a){var e=$.Deferred(),r={type:"text/plain"},o=new File([a],t,r),i=new FormData;return i.append("file-0",o),i.append("auto","false"),i.append("name",t),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:i,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(t){0!=t.error?e.reject():e.resolve()}).fail(function(){e.reject()}).always(function(){moduloActividad.off()}),e.promise()};return{leerTextoPlano:function(t){var a=$.Deferred();return moduloActividad.on(),$.ajax({url:"/storage/read?name="+encodeURIComponent(t),type:"GET",cache:!1,contentType:!1,processData:!1}).done(function(t){a.resolve(t)}).fail(function(){a.reject()}).always(function(){moduloActividad.off()}),a.promise()},escribirTextoPlano:e,subirArchivo:a}}(),manejoPopUps=function(){return{mostrarMenuPagina:function(){pila.push("menu_pagina"),$(".menu_core").toggleClass("invisible"),$(".menu_pagina").toggleClass("invisible"),window.scrollTo(0,0)},mostrarFormularioEdicion:function(t,a,e,r){console.log("mostrarFormularioEdicion",t,a,e),$(".formhtml").attr("nodo2",t),$(".formhtml").attr("property2",a),$(".formhtml").attr("sufijo",r),$(".formhtml textarea").val(e),$(".formhtml").removeClass("invisible"),pila.push("formhtml")}}}();!function(t){function a(a){a.find("[styleProperty]").each(function(a,e){var r=t(e);if("ok"!==r.attr("act_style")){var o,i=r.attr("styleProperty");if(void 0===(o=void 0!==r.attr("about")?r:r.closest("[about]")))return;r.on("click",function(t){if(t.shiftKey){var a=r.attr("style");manejoPopUps.mostrarFormularioEdicion(o.attr("about"),i,a)}else t.ctrlKey&&s(r,i)}),r.attr("act_style","ok")}})}function e(a){a.find("img[property]").each(function(a,e){var r=t(e);"ok"!==r.attr("act_img")&&(t(e).on("click",function(a){var r=t(e);a.altKey?c(r):s(r)}),r.attr("act_img","ok"))})}function r(a){a.find(".editable").each(function(a,e){var r=t(e);if("ok"!==r.attr("act_edt")&&(r.on("click",function(){var a=r.closest("[about]");if(a){if("none"===t("#midgardcreate-save").css("display"))return;manejoPopUps.mostrarFormularioEdicion(a.attr("about"),r.attr("property"),r.html())}}),r.attr("act_edt","ok"),!r.hasClass("textarea_background"))){var o=t('<button type="button" style="padding: 5px !important;">editar</button>');o.bind("click",function(){r.click()}),r.after(o)}})}function o(a){a.find('[textplain="true"]').each(function(a,e){var r=t(e);"ok"!==r.attr("act_tpl")&&(r.on("blur",function(){r.html(r.text())}),r.attr("act_tpl","ok"))})}function i(a){a.find("[dateProperty]").each(function(a,e){var r=t(e),o=r.attr("dateProperty");if("ok"!==r.attr("act_date")){var i=r.closest("[about]");if(i){var d=formatearFecha(r,"dd/MM/yyyy"),l=t('<input style="display: none;" class="datepicker" type="text" autofocuss value="'+d+'" data-valuee="'+d+'"></input>');i.append(l),r.click(function(){l.click()});var c=t('<div style="display: none;" property="'+o+'">'+r.attr("data-value")+"</div>");i.append(c),l.on("change",function(){var a=o,e={},d="0";try{d=parseInt(toDate(l.val()).getTime()/1e3)}catch(t){}e[a]=d;var s=n.entities.get(i.attr("about"));s.set(e);var u=t("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(u,s)&&u.push(s),t("#midgardcreate-save").button({disabled:!1}),r.attr("data-value",d),c.text(d),formatearFecha(r)}),l.pickadate({format:"dd/mm/yyyy",formatSubmit:"dd/mm/yyyy",closeOnSelect:!0,closeOnClear:!0,selectMonths:!0,selectYears:!0})}r.attr("act_date","ok")}})}var n=getVieHere(),d=function(a,e,r,o,i){var n="[about='"+e+"'] [property='"+r+"']",d="[about='"+e+"'] [styleProperty='"+r+"'],[about='"+e+"'][styleProperty='"+r+"']";hayValor(i)||(i="");var l=function(){var n={};n[r+i]=o;var d=a.entities.get(e);d.set(n);var l=t("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),t("#midgardcreate-save").button({disabled:!1})},c=t(n),s=t(d);if(c.length>0){"IMG"==c.prop("tagName")&&("_alt"==i?c.attr("alt",o):c.attr("src",o)),l()}else s.length>0&&(o=o.replace(/"/g,"&quot;"),s.attr("style",o),l())};t("body").append(t('<input type=\'file\' id="formularioImagenes" class="fileEscondido" nodo2="" property2="" />')),t("body").append(t('<div class="formhtml invisible">\t<div class="ctrles"><a class="guardar">Guardar</a>&nbsp;<a class="cancelar">Cancelar</a></div>\t<div class="boxtexto">\t<textarea></textarea>\t</div></div>')),a(t("body"));var l=function(a,e){var r={ok:!1};return"none"===t("#midgardcreate-save").css("display")?r:(void 0!==a.attr("about")?r.padre=a:r.padre=a.closest("[about]"),void 0===r.padre?r:(r.ident=r.padre.attr("about"),hayValor(e)?r.propiedad=e:r.propiedad=a.attr("property"),void 0===r.ident||void 0===r.propiedad?r:(r.ok=!0,r)))},c=function(t){if("IMG"===t.prop("tagName")){var a=l(t);0!=a.ok&&manejoPopUps.mostrarFormularioEdicion(a.ident,a.propiedad,t.attr("alt"),"_alt")}},s=function(a,e){var r=l(a,e);if(0!=r.ok){var o=/(background-image\s*:\s*url\s*\(\s*['"]?)([^'^"]*?)(\s*['"]?\))\s*(!\s*important)?\s*(;)?/gi,i=function(t){var r="http://storage.googleapis.com"+t+"?"+(new Date).getTime();if(hayValor(e)){var i=a.attr("style");return i=i.replace(o,""),i=i.trim(),hayValor(i)&&!i.endsWith(";")&&(i+=";"),i+="background-image: url('"+r+"') !important;",a.attr("style",i),i}return a.attr("src",r),r},c=512e3,s="/imagenesbasico";try{var u=a.attr("data-max");hayValor(u)&&(c=1024*parseInt(u))}catch(t){console.log("Intent� determinar tama�o m�ximo de imagen pero fall�")}var p=a.attr("data-carpeta");"undefined"!==(void 0===p?"undefined":_typeof(p))&&!1!==p&&(p=p.trim(),hayValor(p)&&("/"!=p.charAt(0)&&(p="/"+p),s+=p));var f=moduloArchivos.subirArchivo({dataFolder:s,id:function(){var t=/^(https?:\/\/storage\.googleapis\.com)([^\?]*)(\?.*)?$/gi,r=null;if(hayValor(e)){var i=a.attr("style"),n=o.exec(i);null!=n&&n.length>3&&(r=n[2])}else r=a.attr("src");if(!hayValor(r))return null;var d=t.exec(r);return null!=d&&d.length>=3?d[2]:null}(),maximoTamanio:c});t.when(f).then(function(t){var a=i(t.id);d(n,r.ident,r.propiedad,a)})}};e(t("body")),r(t("body")),o(t("body")),i(t("body")),t("body").bind("midgardeditableenable",function(n,d){var l=d.entity["@subject"],c=/(<)(.*)(>)/g,s=c.exec(l);s=s?s[2]:l;var u=t("[about='"+s+"']");void 0!==u&&(a(u),e(u),r(u),o(u),i(u))}),t("body").midgardCreate({url:function(){return"javascript:false;"},vie:n,highlight:!1,collectionWidgets:{default:"midgardCollectionAdd"}}),configureEditorsHere();t(".formhtml .cancelar").click(function(){t(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}),t(".formhtml .guardar").click(function(){try{var a=t(".formhtml"),e=a.attr("nodo2"),r=a.attr("property2"),o=a.attr("sufijo"),i=t(".formhtml textarea").val();d(n,e,r,i,o),t(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}catch(a){t("body").data("Midgard-midgardNotifications").create({body:"Error "+a})}}),t("#formularioImagenes").change(function(){if(this.files&&this.files[0]){var a=new FileReader;a.onload=function(a){var e=t("#formularioImagenes"),r=e.attr("nodo2"),o=e.attr("property2"),i=t("[about='"+r+"'] [property='"+o+"']"),d={};if(d[o]=a.target.result,i){"IMG"==i.prop("tagName")?i.attr("src",a.target.result):i.attr("style","background-image: url('"+a.target.result+"') !important");var l=n.entities.get(r);l.set(d);var c=t("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(c,l)&&c.push(l),t("#midgardcreate-save").button({disabled:!1})}},a.readAsDataURL(this.files[0])}}),t("textarea[property]").on("change keyup paste",function(){self=t(this);var a=self.attr("property"),e=self.closest("[about]");if(e){var r=e.attr("about"),o=self.val(),i={};i[a]=o;var d=n.entities.get(r);d.set(i);var l=t("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),t("#midgardcreate-save").button({disabled:!1})}})}(jQuery);