var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},hayValor=function(a){return void 0!=a&&null!=a&&(!("string"==typeof a)||a.trim().length>0)},esFuncion=function(a){return"function"==typeof a},esNumero=function(a){return"number"==typeof a||/^\d+$/.test(a)},esBoolean=function(a){return"boolean"==typeof a},esObjeto=function(a){return"object"==(void 0===a?"undefined":_typeof(a))&&null!==a},esLista=function(a){return hayValor(a)&&a instanceof Array},esMultilenguaje=function(a){return/^(\S)+(\.\S+)+$/gim.test(a)},leerObj=function(a,t,o){if(!hayValor(t)||!esObjeto(a))return o;for(var e=t.split("."),r=a,n=0;n<e.length;n++){var i=e[n];if(esNumero(i)&&esLista(r)&&(i=parseInt(i)),r=r[i],n!=e.length-1&&!esObjeto(r))return o}return hayValor(r)?esFuncion(r)?r():r:o};if(!hayValor(moduloActividad))var moduloActividad=function(){var a=0;return{on:function(t){if(hayValor(t)||(t=""),0==a){var o=$('<div id="loading"><p></p></div>');o.find("p").html(t),$("body").append(o)}a++},off:function(){--a<=0&&(a=0,$("#loading").remove())}}}();if(!hayValor(moduloHttp))var moduloHttp=function(){return{get:function(a){var t=$.Deferred();return moduloActividad.on(),$.ajax({url:a,type:"GET",cache:!1}).done(function(a){t.resolve(a)}).fail(function(){t.reject()}).always(function(){moduloActividad.off()}),t.promise()}}}();if(!hayValor(moduloLocal))var moduloLocal=function(){var a={lengua:LENGUAJE},t=null,o=function(a){return esObjeto(t)?leerObj(t,a,a):a},e=function(a){$.each(a.find(".traducir"),function(a,t){var e=$(t),r=e.text();if(esMultilenguaje(r)){var n=o(r);n!=r&&e.html(n)}})};return function(){var o=moduloHttp.get("/assets/cmgae/local/"+a.lengua+".json");$.when(o).then(function(a){t=JSON.parse(a)})}(),{traducir:o,procesarElemento:e}}();if(!hayValor(moduloApp))var moduloApp=function(){var a={URL_LOGIN:URL_LOGIN,URL_LOGOUT:URL_LOGOUT,HAS_USER:HAS_USER,IS_ADMIN:IS_ADMIN},t=function(){return a.IS_ADMIN},o=function(){return a.HAS_USER},e=function(){window.location.href=a.URL_LOGIN},r=function(){window.location.href=a.URL_LOGOUT},n=function(){"full"===$("body").data("Midgard-midgardToolbar").options.display?($("body").data("Midgard-midgardToolbar").__proto__.hide(),$("body").data("Midgard-midgardToolbar").options.display="minimized"):($("body").data("Midgard-midgardToolbar").__proto__.show(),$("body").data("Midgard-midgardToolbar").options.display="full")};return{esAdmin:t,esUsuario:o,login:e,logout:r,borrarCache:function(){var a=$.Deferred();return moduloActividad.on(),$.ajax({type:"GET",url:"/act/clearmemcache",data:JSON.stringify({}),contentType:"application/json; charset=utf-8"}).done(function(t){a.resolve()}).fail(function(t,o){a.reject()}).always(function(){moduloActividad.off()}),a.promise()},abrirBarraEdicion:n}}();if(!hayValor(moduloArchivos))var moduloArchivos=function(){var a=function(a){var t={maximoTamanio:512e3,tipos:"image/*",auto:"true",dataFolder:"/imagenesbasico"};for(var o in t)hayValor(a[o])||(a[o]=t[o]);return a},t=function(t){var o=$.Deferred();t=a(t);var e=$('<input type="file" class="invisible" accept="'+t.tipos+'">');return e.on("change",function(a){var e=a.target.files[0];if(e.size>t.maximoTamanio)return alert("Archivo muy grande! debe ser menor a "+t.maximoTamanio/1024+" KB"),void o.reject();(new FileReader).readAsDataURL(e);var r=new FormData;r.append("file-0",e),r.append("folder",t.dataFolder),hayValor(t.id)&&r.append("name",t.id),"false"==t.auto&&r.append("auto","false"),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:r,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve(a)}).fail(function(){o.reject()}).always(function(){moduloActividad.off()})}),e.click(),o.promise()},o=function(a,t){var o=$.Deferred(),e={type:"text/plain"},r=new File([t],a,e),n=new FormData;return n.append("file-0",r),n.append("auto","false"),n.append("name",a),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:n,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve()}).fail(function(){o.reject()}).always(function(){moduloActividad.off()}),o.promise()};return{leerTextoPlano:function(a){var t=$.Deferred();return moduloActividad.on(),$.ajax({url:"/storage/read?name="+encodeURIComponent(a),type:"GET",cache:!1,contentType:!1,processData:!1}).done(function(a){t.resolve(a)}).fail(function(){t.reject()}).always(function(){moduloActividad.off()}),t.promise()},escribirTextoPlano:o,subirArchivo:t}}();if(!hayValor(moduloMenus))var moduloMenus=function(){var a=[],t=function(a){return moduloHttp.get("/assets/cmgae/menus"+a)},o=function(t){return 0!=a.length&&a[a.length-1].id==t},e=function(){if(0!=a.length){a[a.length-1].nodo.remove(),a.pop()}},r=function(a){var o=t("/soloTexto.html");$.when(o).then(function(t){d("alerta",t,{html:{".mensaje_texto":a}})})},n=function(a){$.when(a).then(function(){r("Hecho!")},function(){r("Error :(")})},i=function(a,t){moduloLocal.procesarElemento(a);var o={funciones:{".menu_opc_ingresar":moduloApp.login,".menu_opc_salir":moduloApp.logout,".menu_opc_borrar_cache":moduloApp.borrarCache,".create-ui-toggle2":moduloApp.abrirBarraEdicion,".menuEliminar":moduloEdicion.funcElegirBorrar},html:{}};o=$.extend(o,t),$.each(o.funciones,function(t,o){a.find(t).on("click",function(){e();var a=o();hayValor(a)&&n(a)})});for(var r in o.html)a.find(r).html(o.html[r])},d=function(t,o,e){var r=$(o);$("body").append(r),a.push({id:t,nodo:r}),i(r,e)},l=function(){var a=$.Deferred();if(o("menu"))return e(),a.reject(),a.promise();var r=null;return r=t(moduloApp.esUsuario()?moduloApp.esAdmin()?"/menuInicialAdmin.html":"/menuInicialAnonimo.html":"/menuInicialAnonimo.html"),$.when(r).then(function(t){d("menu",t),a.resolve()}),a.promise()},c=function(){pila.push("menu_pagina"),$(".menu_core").toggleClass("invisible"),$(".menu_pagina").toggleClass("invisible"),window.scrollTo(0,0)},u=function(a,t,o,e){pila.push("formhtml"),console.log("mostrarFormularioEdicion",a,t,o),$(".formhtml").attr("nodo2",a),$(".formhtml").attr("property2",t),$(".formhtml").attr("sufijo",e),$(".formhtml textarea").val(o),$(".formhtml").removeClass("invisible")};return $(document).keyup(function(t){27==t.keyCode&&(0==a.length?l():e())}),{mostrarMenuPagina:c,mostrarFormularioEdicion:u,mostrarMenuBasico:l,mostrarMenuSoloTexto:r}}();if(!hayValor(moduloEdicion))var moduloEdicion=function(){var mapaIds={},activarEdicionOk=!1,activarEdicion=function(){1!=activarEdicionOk&&"undefined"!=typeof Backbone&&(Backbone.sync=function(a,t,o){try{var e=t.toJSON(),r=e["@subject"];t.isNew()&&(r in mapaIds?e["@subject"]=mapaIds[r]:(e["@subject"]="<"+(new Date).getTime()+"_"+Math.floor(10*Math.random()+1)+">",mapaIds[r]=e["@subject"]));var n=e["@subject"],i=e["@type"],d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(i),l=null;d&&(l=d[2]);var c=/(<)(.*)(>)/g,u=c.exec(n);if(null==u)return void o.error("error: no es identificador "+n);var s=u[2],f={};for(var p in e){var d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(p);d&&(f[d[2]]=e[p])}var m={};switch(m.payload=f,m.leng=LENGUAJE,a){case"create":case"update":moduloActividad.on(),$.ajax({type:"PUT",url:"/rest/"+(null===l||void 0===l?"Documento":l)+"/"+s,data:JSON.stringify(m),contentType:"application/json; charset=utf-8"}).done(function(a){o.success(t)}).fail(function(a,t){o.error("error")}).always(function(){moduloActividad.off()})}}catch(a){o.error("error "+a)}},activarEdicionOk=!0)},activarPaginacion=function activarPaginacion(nodo){function activatePageA(actual){var cursor=actual.attr("data-next"),busqueda=JSON.parse(actual.attr("data-q")),template=actual.attr("data-tpl"),target=actual.attr("data-target"),ipage=parseInt(actual.attr("data-page"));busqueda.n||(busqueda.n=100),moduloApp.esAdmin()||actual.html(ipage*busqueda.n+1+" al "+(ipage+1)*busqueda.n),"1"===actual.attr("data-noa")&&(actual.removeAttr("href"),actual.on("click",function(){var docHtml=document.getElementById(template).innerHTML,destino=$(target),postload=destino.attr("data-postload");destino.length>0&&(moduloActividad.on(),$.ajax({type:"PUT",url:"/paginar/",data:JSON.stringify({busqueda:busqueda,cursor:cursor}),contentType:"application/json; charset=utf-8"}).done(function(msg){var datos=msg.datos,sigui=msg.next;destino.empty();for(var i=0;i<datos.length;i++){var dato=datos[i],nuevo=$(docHtml);llenarTemplate(nuevo,dato),destino.append(nuevo)}if(void 0!==sigui&&sigui.length>0){var padrePaginacion=actual.closest(".paginacion");if(0==padrePaginacion.find("[data-next='"+sigui+"']").length){for(var padreLocal=actual.parent(),nombreTAG=padreLocal.prop("tagName"),cambio=!1;padreLocal.get(0)!=padrePaginacion.get(0)&&"BODY"!=nombreTAG;)cambio=!0,actual=padreLocal,padreLocal=padreLocal.parent(),nombreTAG=padreLocal.prop("tagName");var paginaSigui=actual.clone(),paginaSigui2;paginaSigui2=cambio?paginaSigui.find("[data-next]"):paginaSigui,paginaSigui2.attr("data-page",ipage+1),paginaSigui2.attr("data-next",sigui),padrePaginacion.append(paginaSigui),activatePageA(paginaSigui2)}}void 0!==postload&&eval(postload)}).fail(function(a,t){moduloMenus.mostrarMenuSoloTexto("Error paginando")}).always(function(){moduloActividad.off()}))}))}hayValor(nodo)||(nodo=$("body")),$.each(nodo.find("a[data-next]"),function(a,t){activatePageA($(t))})},funcElegirBorrar=function(){var a=$(".btnEliminar");a.length>0?a.remove():$("[about]").each(function(a){var t=$(this),o=t.find(".btnEliminar");if(0==o.length){t.prepend($('<div class="btnEliminar"><div class="btnEliminarX btnEliminar2 manito"></div><div class="btnEliminarX opciones invisible">\t<div class="btnEliminar3"></div>\t<div class="btnEliminar4 manito">Cancelar</div>\t<div class="btnEliminar5 manito">Aceptar</div></div></div>')),o=t.find(".btnEliminar");var e=o.find(".btnEliminar2"),r=o.find(".btnEliminar4"),n=o.find(".btnEliminar5");e.click(function(){var a=$(this);a.addClass("invisible"),a.siblings(".opciones").removeClass("invisible")}),n.click(function(){var a=$(this),t=a.closest("[about]");if(t.length>0){var o=t.attr("about"),e=null;e=t.attr("typeof");var r=(null===e||void 0===e?"":e)+"_"+o;r in mapaIds&&(o=mapaIds[r]),moduloActividad.on(),$.ajax({type:"DELETE",url:"/rest/"+(null===e||void 0===e?"":e)+"/"+o}).done(function(a){t.remove(),$("body").data("Midgard-midgardNotifications").create({body:JSON.stringify(a)}),location.reload()}).fail(function(a,t){$("body").data("Midgard-midgardNotifications").create({body:TRADUCTOR.error_ajax[LENGUAJE]})}).always(function(){moduloActividad.off()})}}),r.click(function(){var a=$(this);a.closest(".opciones").addClass("invisible"),a.closest(".btnEliminar").find(".btnEliminar2").removeClass("invisible")})}}),"menu"===pila[pila.length-1]&&pila.pop()};return activarPaginacion(),{activarPaginacion:activarPaginacion,activarEdicion:activarEdicion,funcElegirBorrar:funcElegirBorrar}}();!function(a){function t(t){t.find("[styleProperty]").each(function(t,o){var e=a(o);if("ok"!==e.attr("act_style")){var r,n=e.attr("styleProperty");if(void 0===(r=void 0!==e.attr("about")?e:e.closest("[about]")))return;e.on("click",function(a){if(a.shiftKey){var t=e.attr("style");moduloMenus.mostrarFormularioEdicion(r.attr("about"),n,t)}else a.ctrlKey&&u(e,n)}),e.attr("act_style","ok")}})}function o(t){t.find("img[property]").each(function(t,o){var e=a(o);"ok"!==e.attr("act_img")&&(a(o).on("click",function(t){var e=a(o);t.altKey?c(e):u(e)}),e.attr("act_img","ok"))})}function e(t){t.find(".editable").each(function(t,o){var e=a(o);if("ok"!==e.attr("act_edt")&&(e.on("click",function(){var t=e.closest("[about]");if(t){if("none"===a("#midgardcreate-save").css("display"))return;moduloMenus.mostrarFormularioEdicion(t.attr("about"),e.attr("property"),e.html())}}),e.attr("act_edt","ok"),!e.hasClass("textarea_background"))){var r=a('<button type="button" style="padding: 5px !important;">editar</button>');r.bind("click",function(){e.click()}),e.after(r)}})}function r(t){t.find('[textplain="true"]').each(function(t,o){var e=a(o);"ok"!==e.attr("act_tpl")&&(e.on("blur",function(){e.html(e.text())}),e.attr("act_tpl","ok"))})}function n(t){t.find("[dateProperty]").each(function(t,o){var e=a(o),r=e.attr("dateProperty");if("ok"!==e.attr("act_date")){var n=e.closest("[about]");if(n){var d=formatearFecha(e,"dd/MM/yyyy"),l=a('<input style="display: none;" class="datepicker" type="text" autofocuss value="'+d+'" data-valuee="'+d+'"></input>');n.append(l),e.click(function(){l.click()});var c=a('<div style="display: none;" property="'+r+'">'+e.attr("data-value")+"</div>");n.append(c),l.on("change",function(){var t=r,o={},d="0";try{d=parseInt(toDate(l.val()).getTime()/1e3)}catch(a){}o[t]=d;var u=i.entities.get(n.attr("about"));u.set(o);var s=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(s,u)&&s.push(u),a("#midgardcreate-save").button({disabled:!1}),e.attr("data-value",d),c.text(d),formatearFecha(e)}),l.pickadate({format:"dd/mm/yyyy",formatSubmit:"dd/mm/yyyy",closeOnSelect:!0,closeOnClear:!0,selectMonths:!0,selectYears:!0})}e.attr("act_date","ok")}})}var i=getVieHere(),d=function(t,o,e,r,n){var i="[about='"+o+"'] [property='"+e+"']",d="[about='"+o+"'] [styleProperty='"+e+"'],[about='"+o+"'][styleProperty='"+e+"']";hayValor(n)||(n="");var l=function(){var i={};i[e+n]=r;var d=t.entities.get(o);d.set(i);var l=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),a("#midgardcreate-save").button({disabled:!1})},c=a(i),u=a(d);if(c.length>0){"IMG"==c.prop("tagName")&&("_alt"==n?c.attr("alt",r):c.attr("src",r)),l()}else u.length>0&&(r=r.replace(/"/g,"&quot;"),u.attr("style",r),l())};a("body").append(a('<input type=\'file\' id="formularioImagenes" class="fileEscondido" nodo2="" property2="" />')),a("body").append(a('<div class="formhtml invisible">\t<div class="ctrles"><a class="guardar">Guardar</a>&nbsp;<a class="cancelar">Cancelar</a></div>\t<div class="boxtexto">\t<textarea></textarea>\t</div></div>')),t(a("body"));var l=function(t,o){var e={ok:!1};return"none"===a("#midgardcreate-save").css("display")?e:(void 0!==t.attr("about")?e.padre=t:e.padre=t.closest("[about]"),void 0===e.padre?e:(e.ident=e.padre.attr("about"),hayValor(o)?e.propiedad=o:e.propiedad=t.attr("property"),void 0===e.ident||void 0===e.propiedad?e:(e.ok=!0,e)))},c=function(a){if("IMG"===a.prop("tagName")){var t=l(a);0!=t.ok&&moduloMenus.mostrarFormularioEdicion(t.ident,t.propiedad,a.attr("alt"),"_alt")}},u=function(t,o){var e=l(t,o);if(0!=e.ok){var r=/(background-image\s*:\s*url\s*\(\s*['"]?)([^'^"]*?)(\s*['"]?\))\s*(!\s*important)?\s*(;)?/gi,n=function(a){var e="http://storage.googleapis.com"+a+"?"+(new Date).getTime();if(hayValor(o)){var n=t.attr("style");return n=n.replace(r,""),n=n.trim(),hayValor(n)&&!n.endsWith(";")&&(n+=";"),n+="background-image: url('"+e+"') !important;",t.attr("style",n),n}return t.attr("src",e),e},c=512e3,u="/imagenesbasico";try{var s=t.attr("data-max");hayValor(s)&&(c=1024*parseInt(s))}catch(a){console.log("Intent� determinar tama�o m�ximo de imagen pero fall�")}var f=t.attr("data-carpeta");"undefined"!==(void 0===f?"undefined":_typeof(f))&&!1!==f&&(f=f.trim(),hayValor(f)&&("/"!=f.charAt(0)&&(f="/"+f),u+=f));var p=moduloArchivos.subirArchivo({dataFolder:u,id:function(){var a=/^(https?:\/\/storage\.googleapis\.com)([^\?]*)(\?.*)?$/gi,e=null;if(hayValor(o)){var n=t.attr("style"),i=r.exec(n);null!=i&&i.length>3&&(e=i[2])}else e=t.attr("src");if(!hayValor(e))return null;var d=a.exec(e);return null!=d&&d.length>=3?d[2]:null}(),maximoTamanio:c});a.when(p).then(function(a){var t=n(a.id);d(i,e.ident,e.propiedad,t)})}};o(a("body")),e(a("body")),r(a("body")),n(a("body")),a("body").bind("midgardeditableenable",function(i,d){var l=d.entity["@subject"],c=/(<)(.*)(>)/g,u=c.exec(l);u=u?u[2]:l;var s=a("[about='"+u+"']");void 0!==s&&(t(s),o(s),e(s),r(s),n(s))}),a("body").midgardCreate({url:function(){return"javascript:false;"},vie:i,highlight:!1,collectionWidgets:{default:"midgardCollectionAdd"}}),configureEditorsHere();a(".formhtml .cancelar").click(function(){a(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}),a(".formhtml .guardar").click(function(){try{var t=a(".formhtml"),o=t.attr("nodo2"),e=t.attr("property2"),r=t.attr("sufijo"),n=a(".formhtml textarea").val();d(i,o,e,n,r),a(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}catch(t){a("body").data("Midgard-midgardNotifications").create({body:"Error "+t})}}),a("#formularioImagenes").change(function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(t){var o=a("#formularioImagenes"),e=o.attr("nodo2"),r=o.attr("property2"),n=a("[about='"+e+"'] [property='"+r+"']"),d={};if(d[r]=t.target.result,n){"IMG"==n.prop("tagName")?n.attr("src",t.target.result):n.attr("style","background-image: url('"+t.target.result+"') !important");var l=i.entities.get(e);l.set(d);var c=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(c,l)&&c.push(l),a("#midgardcreate-save").button({disabled:!1})}},t.readAsDataURL(this.files[0])}}),a("textarea[property]").on("change keyup paste",function(){self=a(this);var t=self.attr("property"),o=self.closest("[about]");if(o){var e=o.attr("about"),r=self.val(),n={};n[t]=r;var d=i.entities.get(e);d.set(n);var l=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),a("#midgardcreate-save").button({disabled:!1})}})}(jQuery);