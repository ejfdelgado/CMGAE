var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},hayValor=function(a){return void 0!=a&&null!=a&&(!("string"==typeof a)||a.trim().length>0)},esFuncion=function(a){return"function"==typeof a};if(!hayValor(moduloActividad))var moduloActividad=function(){var a=0;return{on:function(){0==a&&$("body").append('<div id="loading"><p>Procesando petici&oacute;n...</p></div>'),a++},off:function(){--a<=0&&(a=0,$("#loading").remove())}}}();if(!hayValor(moduloApp))var moduloApp=function(){var a={URL_LOGIN:URL_LOGIN,URL_LOGOUT:URL_LOGOUT,HAS_USER:HAS_USER,IS_ADMIN:IS_ADMIN},t=function(){return a.IS_ADMIN},o=function(){return a.HAS_USER},e=function(){window.location.href=a.URL_LOGIN},i=function(){window.location.href=a.URL_LOGOUT},r=function(){"full"===$("body").data("Midgard-midgardToolbar").options.display?($("body").data("Midgard-midgardToolbar").__proto__.hide(),$("body").data("Midgard-midgardToolbar").options.display="minimized"):($("body").data("Midgard-midgardToolbar").__proto__.show(),$("body").data("Midgard-midgardToolbar").options.display="full")};return{esAdmin:t,esUsuario:o,login:e,logout:i,borrarCache:function(){var a=$.Deferred();return moduloActividad.on(),$.ajax({type:"GET",url:"/act/clearmemcache",data:JSON.stringify({}),contentType:"application/json; charset=utf-8"}).done(function(t){a.resolve()}).fail(function(t,o){a.reject()}).always(function(){moduloActividad.off()}),a.promise()},abrirBarraEdicion:r}}();if(!hayValor(moduloArchivos))var moduloArchivos=function(){var a=function(a){var t={maximoTamanio:512e3,tipos:"image/*",auto:"true",dataFolder:"/imagenesbasico"};for(var o in t)hayValor(a[o])||(a[o]=t[o]);return a},t=function(t){var o=$.Deferred();t=a(t);var e=$('<input type="file" class="invisible" accept="'+t.tipos+'">');return e.on("change",function(a){var e=a.target.files[0];if(e.size>t.maximoTamanio)return alert("Archivo muy grande! debe ser menor a "+t.maximoTamanio/1024+" KB"),void o.reject();(new FileReader).readAsDataURL(e);var i=new FormData;i.append("file-0",e),i.append("folder",t.dataFolder),hayValor(t.id)&&i.append("name",t.id),"false"==t.auto&&i.append("auto","false"),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:i,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve(a)}).fail(function(){o.reject()}).always(function(){moduloActividad.off()})}),e.click(),o.promise()},o=function(a,t){var o=$.Deferred(),e={type:"text/plain"},i=new File([t],a,e),r=new FormData;return r.append("file-0",i),r.append("auto","false"),r.append("name",a),moduloActividad.on(),$.ajax({url:"/storage/",type:"POST",data:r,headers:{"X-CSRFToken":$('[name="csrfmiddlewaretoken"]').val()},cache:!1,contentType:!1,processData:!1}).done(function(a){0!=a.error?o.reject():o.resolve()}).fail(function(){o.reject()}).always(function(){moduloActividad.off()}),o.promise()};return{leerTextoPlano:function(a){var t=$.Deferred();return moduloActividad.on(),$.ajax({url:"/storage/read?name="+encodeURIComponent(a),type:"GET",cache:!1,contentType:!1,processData:!1}).done(function(a){t.resolve(a)}).fail(function(){t.reject()}).always(function(){moduloActividad.off()}),t.promise()},escribirTextoPlano:o,subirArchivo:t}}();if(!hayValor(moduloMenus))var moduloMenus=function(){var a=[],t=function(a){var t=$.Deferred();return moduloActividad.on(),$.ajax({url:"/assets/cmgae/menus"+a,type:"GET",cache:!1}).done(function(a){t.resolve(a)}).fail(function(){t.reject()}).always(function(){moduloActividad.off()}),t.promise()},o=function(t){return 0!=a.length&&a[a.length-1].id==t},e=function(){if(0!=a.length){a[a.length-1].nodo.remove(),a.pop()}},i=function(a){var o=t("/soloTexto.html");$.when(o).then(function(t){d("alerta",t,{html:{".mensaje_texto":a}})})},r=function(a){$.when(a).then(function(){i("Hecho!")},function(){i("Error :(")})},n=function(a,t){var o={funciones:{".menu_opc_ingresar":moduloApp.login,".menu_opc_salir":moduloApp.logout,".menu_opc_borrar_cache":moduloApp.borrarCache,".create-ui-toggle2":moduloApp.abrirBarraEdicion,".menuEliminar":moduloEdicion.funcElegirBorrar},html:{}};o=$.extend(o,t),$.each(o.funciones,function(t,o){a.find(t).on("click",function(){e();var a=o();hayValor(a)&&r(a)})});for(var i in o.html)a.find(i).html(o.html[i])},d=function(t,o,e){var i=$(o);$("body").append(i),a.push({id:t,nodo:i}),n(i,e)},l=function(){var a=$.Deferred();if(o("menu"))return e(),a.reject(),a.promise();var i=null;return i=t(moduloApp.esUsuario()?moduloApp.esAdmin()?"/menuInicialAdmin.html":"/menuInicialAnonimo.html":"/menuInicialAnonimo.html"),$.when(i).then(function(t){d("menu",t),a.resolve()}),a.promise()},c=function(){pila.push("menu_pagina"),$(".menu_core").toggleClass("invisible"),$(".menu_pagina").toggleClass("invisible"),window.scrollTo(0,0)},u=function(a,t,o,e){pila.push("formhtml"),console.log("mostrarFormularioEdicion",a,t,o),$(".formhtml").attr("nodo2",a),$(".formhtml").attr("property2",t),$(".formhtml").attr("sufijo",e),$(".formhtml textarea").val(o),$(".formhtml").removeClass("invisible")};return $(document).keyup(function(t){27==t.keyCode&&(0==a.length?l():e())}),{mostrarMenuPagina:c,mostrarFormularioEdicion:u,mostrarMenuBasico:l,mostrarMenuSoloTexto:i}}();if(!hayValor(moduloEdicion))var moduloEdicion=function(){var mapaIds={},activarEdicion=function(){"undefined"!=typeof Backbone&&(Backbone.sync=function(a,t,o){try{var e=t.toJSON(),i=e["@subject"];t.isNew()&&(i in mapaIds?e["@subject"]=mapaIds[i]:(e["@subject"]="<"+(new Date).getTime()+"_"+Math.floor(10*Math.random()+1)+">",mapaIds[i]=e["@subject"]));var r=e["@subject"],n=e["@type"],d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(n),l=null;d&&(l=d[2]);var c=/(<)(.*)(>)/g,u=c.exec(r);if(null==u)return void o.error("error: no es identificador "+r);var s=u[2],p={};for(var f in e){var d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(f);d&&(p[d[2]]=e[f])}var m={};switch(m.payload=p,m.leng=LENGUAJE,a){case"create":case"update":moduloActividad.on(),$.ajax({type:"PUT",url:"/rest/"+(null===l||void 0===l?"Documento":l)+"/"+s,data:JSON.stringify(m),contentType:"application/json; charset=utf-8"}).done(function(a){o.success(t)}).fail(function(a,t){o.error("error")}).always(function(){moduloActividad.off()})}}catch(a){o.error("error "+a)}})},activarPaginacion=function activarPaginacion(nodo){function activatePageA(actual){var cursor=actual.attr("data-next"),busqueda=JSON.parse(actual.attr("data-q")),template=actual.attr("data-tpl"),target=actual.attr("data-target"),ipage=parseInt(actual.attr("data-page"));busqueda.n||(busqueda.n=100),moduloApp.esAdmin()||actual.html(ipage*busqueda.n+1+" al "+(ipage+1)*busqueda.n),"1"===actual.attr("data-noa")&&(actual.removeAttr("href"),actual.on("click",function(){var docHtml=document.getElementById(template).innerHTML,destino=$(target),postload=destino.attr("data-postload");destino.length>0&&(moduloActividad.on(),$.ajax({type:"PUT",url:"/paginar/",data:JSON.stringify({busqueda:busqueda,cursor:cursor}),contentType:"application/json; charset=utf-8"}).done(function(msg){var datos=msg.datos,sigui=msg.next;destino.empty();for(var i=0;i<datos.length;i++){var dato=datos[i],nuevo=$(docHtml);llenarTemplate(nuevo,dato),destino.append(nuevo)}if(void 0!==sigui&&sigui.length>0){var padrePaginacion=actual.closest(".paginacion");if(0==padrePaginacion.find("[data-next='"+sigui+"']").length){for(var padreLocal=actual.parent(),nombreTAG=padreLocal.prop("tagName"),cambio=!1;padreLocal.get(0)!=padrePaginacion.get(0)&&"BODY"!=nombreTAG;)cambio=!0,actual=padreLocal,padreLocal=padreLocal.parent(),nombreTAG=padreLocal.prop("tagName");var paginaSigui=actual.clone(),paginaSigui2;paginaSigui2=cambio?paginaSigui.find("[data-next]"):paginaSigui,paginaSigui2.attr("data-page",ipage+1),paginaSigui2.attr("data-next",sigui),padrePaginacion.append(paginaSigui),activatePageA(paginaSigui2)}}void 0!==postload&&eval(postload)}).fail(function(a,t){moduloMenus.mostrarMenuSoloTexto("Error paginando")}).always(function(){moduloActividad.off()}))}))}hayValor(nodo)||(nodo=$("body")),nodo.find("a[data-next]").each(function(a,t){activatePageA($(t))})},funcElegirBorrar=function(){var a=$(".btnEliminar");a.length>0?a.remove():$("[about]").each(function(a){var t=$(this),o=t.find(".btnEliminar");if(0==o.length){t.prepend($('<div class="btnEliminar"><div class="btnEliminarX btnEliminar2 manito"></div><div class="btnEliminarX opciones invisible">\t<div class="btnEliminar3"></div>\t<div class="btnEliminar4 manito">Cancelar</div>\t<div class="btnEliminar5 manito">Aceptar</div></div></div>')),o=t.find(".btnEliminar");var e=o.find(".btnEliminar2"),i=o.find(".btnEliminar4"),r=o.find(".btnEliminar5");e.click(function(){var a=$(this);a.addClass("invisible"),a.siblings(".opciones").removeClass("invisible")}),r.click(function(){var a=$(this),t=a.closest("[about]");if(t.length>0){var o=t.attr("about"),e=null;e=t.attr("typeof");var i=(null===e||void 0===e?"":e)+"_"+o;i in mapaIds&&(o=mapaIds[i]),moduloActividad.on(),$.ajax({type:"DELETE",url:"/rest/"+(null===e||void 0===e?"":e)+"/"+o}).done(function(a){t.remove(),$("body").data("Midgard-midgardNotifications").create({body:JSON.stringify(a)}),location.reload()}).fail(function(a,t){$("body").data("Midgard-midgardNotifications").create({body:TRADUCTOR.error_ajax[LENGUAJE]})}).always(function(){moduloActividad.off()})}}),i.click(function(){var a=$(this);a.closest(".opciones").addClass("invisible"),a.closest(".btnEliminar").find(".btnEliminar2").removeClass("invisible")})}}),"menu"===pila[pila.length-1]&&pila.pop()};return activarPaginacion(),{activarPaginacion:activarPaginacion,activarEdicion:activarEdicion,funcElegirBorrar:funcElegirBorrar}}();!function(a){function t(t){t.find("[styleProperty]").each(function(t,o){var e=a(o);if("ok"!==e.attr("act_style")){var i,r=e.attr("styleProperty");if(void 0===(i=void 0!==e.attr("about")?e:e.closest("[about]")))return;e.on("click",function(a){if(a.shiftKey){var t=e.attr("style");moduloMenus.mostrarFormularioEdicion(i.attr("about"),r,t)}else a.ctrlKey&&u(e,r)}),e.attr("act_style","ok")}})}function o(t){t.find("img[property]").each(function(t,o){var e=a(o);"ok"!==e.attr("act_img")&&(a(o).on("click",function(t){var e=a(o);t.altKey?c(e):u(e)}),e.attr("act_img","ok"))})}function e(t){t.find(".editable").each(function(t,o){var e=a(o);if("ok"!==e.attr("act_edt")&&(e.on("click",function(){var t=e.closest("[about]");if(t){if("none"===a("#midgardcreate-save").css("display"))return;moduloMenus.mostrarFormularioEdicion(t.attr("about"),e.attr("property"),e.html())}}),e.attr("act_edt","ok"),!e.hasClass("textarea_background"))){var i=a('<button type="button" style="padding: 5px !important;">editar</button>');i.bind("click",function(){e.click()}),e.after(i)}})}function i(t){t.find('[textplain="true"]').each(function(t,o){var e=a(o);"ok"!==e.attr("act_tpl")&&(e.on("blur",function(){e.html(e.text())}),e.attr("act_tpl","ok"))})}function r(t){t.find("[dateProperty]").each(function(t,o){var e=a(o),i=e.attr("dateProperty");if("ok"!==e.attr("act_date")){var r=e.closest("[about]");if(r){var d=formatearFecha(e,"dd/MM/yyyy"),l=a('<input style="display: none;" class="datepicker" type="text" autofocuss value="'+d+'" data-valuee="'+d+'"></input>');r.append(l),e.click(function(){l.click()});var c=a('<div style="display: none;" property="'+i+'">'+e.attr("data-value")+"</div>");r.append(c),l.on("change",function(){var t=i,o={},d="0";try{d=parseInt(toDate(l.val()).getTime()/1e3)}catch(a){}o[t]=d;var u=n.entities.get(r.attr("about"));u.set(o);var s=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(s,u)&&s.push(u),a("#midgardcreate-save").button({disabled:!1}),e.attr("data-value",d),c.text(d),formatearFecha(e)}),l.pickadate({format:"dd/mm/yyyy",formatSubmit:"dd/mm/yyyy",closeOnSelect:!0,closeOnClear:!0,selectMonths:!0,selectYears:!0})}e.attr("act_date","ok")}})}var n=getVieHere(),d=function(t,o,e,i,r){var n="[about='"+o+"'] [property='"+e+"']",d="[about='"+o+"'] [styleProperty='"+e+"'],[about='"+o+"'][styleProperty='"+e+"']";hayValor(r)||(r="");var l=function(){var n={};n[e+r]=i;var d=t.entities.get(o);d.set(n);var l=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),a("#midgardcreate-save").button({disabled:!1})},c=a(n),u=a(d);if(c.length>0){"IMG"==c.prop("tagName")&&("_alt"==r?c.attr("alt",i):c.attr("src",i)),l()}else u.length>0&&(i=i.replace(/"/g,"&quot;"),u.attr("style",i),l())};a("body").append(a('<input type=\'file\' id="formularioImagenes" class="fileEscondido" nodo2="" property2="" />')),a("body").append(a('<div class="formhtml invisible">\t<div class="ctrles"><a class="guardar">Guardar</a>&nbsp;<a class="cancelar">Cancelar</a></div>\t<div class="boxtexto">\t<textarea></textarea>\t</div></div>')),t(a("body"));var l=function(t,o){var e={ok:!1};return"none"===a("#midgardcreate-save").css("display")?e:(void 0!==t.attr("about")?e.padre=t:e.padre=t.closest("[about]"),void 0===e.padre?e:(e.ident=e.padre.attr("about"),hayValor(o)?e.propiedad=o:e.propiedad=t.attr("property"),void 0===e.ident||void 0===e.propiedad?e:(e.ok=!0,e)))},c=function(a){if("IMG"===a.prop("tagName")){var t=l(a);0!=t.ok&&moduloMenus.mostrarFormularioEdicion(t.ident,t.propiedad,a.attr("alt"),"_alt")}},u=function(t,o){var e=l(t,o);if(0!=e.ok){var i=/(background-image\s*:\s*url\s*\(\s*['"]?)([^'^"]*?)(\s*['"]?\))\s*(!\s*important)?\s*(;)?/gi,r=function(a){var e="http://storage.googleapis.com"+a+"?"+(new Date).getTime();if(hayValor(o)){var r=t.attr("style");return r=r.replace(i,""),r=r.trim(),hayValor(r)&&!r.endsWith(";")&&(r+=";"),r+="background-image: url('"+e+"') !important;",t.attr("style",r),r}return t.attr("src",e),e},c=512e3,u="/imagenesbasico";try{var s=t.attr("data-max");hayValor(s)&&(c=1024*parseInt(s))}catch(a){console.log("Intent� determinar tama�o m�ximo de imagen pero fall�")}var p=t.attr("data-carpeta");"undefined"!==(void 0===p?"undefined":_typeof(p))&&!1!==p&&(p=p.trim(),hayValor(p)&&("/"!=p.charAt(0)&&(p="/"+p),u+=p));var f=moduloArchivos.subirArchivo({dataFolder:u,id:function(){var a=/^(https?:\/\/storage\.googleapis\.com)([^\?]*)(\?.*)?$/gi,e=null;if(hayValor(o)){var r=t.attr("style"),n=i.exec(r);null!=n&&n.length>3&&(e=n[2])}else e=t.attr("src");if(!hayValor(e))return null;var d=a.exec(e);return null!=d&&d.length>=3?d[2]:null}(),maximoTamanio:c});a.when(f).then(function(a){var t=r(a.id);d(n,e.ident,e.propiedad,t)})}};o(a("body")),e(a("body")),i(a("body")),r(a("body")),a("body").bind("midgardeditableenable",function(n,d){var l=d.entity["@subject"],c=/(<)(.*)(>)/g,u=c.exec(l);u=u?u[2]:l;var s=a("[about='"+u+"']");void 0!==s&&(t(s),o(s),e(s),i(s),r(s))}),a("body").midgardCreate({url:function(){return"javascript:false;"},vie:n,highlight:!1,collectionWidgets:{default:"midgardCollectionAdd"}}),configureEditorsHere();a(".formhtml .cancelar").click(function(){a(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}),a(".formhtml .guardar").click(function(){try{var t=a(".formhtml"),o=t.attr("nodo2"),e=t.attr("property2"),i=t.attr("sufijo"),r=a(".formhtml textarea").val();d(n,o,e,r,i),a(".formhtml").addClass("invisible"),"formhtml"===pila[pila.length-1]&&pila.pop()}catch(t){a("body").data("Midgard-midgardNotifications").create({body:"Error "+t})}}),a("#formularioImagenes").change(function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(t){var o=a("#formularioImagenes"),e=o.attr("nodo2"),i=o.attr("property2"),r=a("[about='"+e+"'] [property='"+i+"']"),d={};if(d[i]=t.target.result,r){"IMG"==r.prop("tagName")?r.attr("src",t.target.result):r.attr("style","background-image: url('"+t.target.result+"') !important");var l=n.entities.get(e);l.set(d);var c=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(c,l)&&c.push(l),a("#midgardcreate-save").button({disabled:!1})}},t.readAsDataURL(this.files[0])}}),a("textarea[property]").on("change keyup paste",function(){self=a(this);var t=self.attr("property"),o=self.closest("[about]");if(o){var e=o.attr("about"),i=self.val(),r={};r[t]=i;var d=n.entities.get(e);d.set(r);var l=a("body").data("Midgard-midgardStorage").changedModels;-1===_.indexOf(l,d)&&l.push(d),a("#midgardcreate-save").button({disabled:!1})}})}(jQuery);