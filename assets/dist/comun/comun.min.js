var hayValor=function(a){return void 0!=a&&null!=a&&(!("string"==typeof a)||a.trim().length>0)},esFuncion=function(a){return"function"==typeof a};if(!hayValor(moduloActividad))var moduloActividad=function(){var a=0;return{on:function(){0==a&&$("body").append('<div id="loading"><p>Procesando petici&oacute;n...</p></div>'),a++},off:function(){--a<=0&&(a=0,$("#loading").remove())}}}();if(!hayValor(moduloApp))var moduloApp=function(){var a={URL_LOGIN:URL_LOGIN,URL_LOGOUT:URL_LOGOUT,HAS_USER:HAS_USER,IS_ADMIN:IS_ADMIN},i=function(){return a.IS_ADMIN},n=function(){return a.HAS_USER},o=function(){window.location.href=a.URL_LOGIN},t=function(){window.location.href=a.URL_LOGOUT},r=function(){"full"===$("body").data("Midgard-midgardToolbar").options.display?($("body").data("Midgard-midgardToolbar").__proto__.hide(),$("body").data("Midgard-midgardToolbar").options.display="minimized"):($("body").data("Midgard-midgardToolbar").__proto__.show(),$("body").data("Midgard-midgardToolbar").options.display="full")};return{esAdmin:i,esUsuario:n,login:o,logout:t,borrarCache:function(){var a=$.Deferred();return moduloActividad.on(),$.ajax({type:"GET",url:"/act/clearmemcache",data:JSON.stringify({}),contentType:"application/json; charset=utf-8"}).done(function(i){a.resolve()}).fail(function(i,n){a.reject()}).always(function(){moduloActividad.off()}),a.promise()},abrirBarraEdicion:r}}();if(!hayValor(moduloMenus))var moduloMenus=function(){var a=[],i=function(a){var i=$.Deferred();return moduloActividad.on(),$.ajax({url:"/assets/cmgae/menus"+a,type:"GET",cache:!1}).done(function(a){i.resolve(a)}).fail(function(){i.reject()}).always(function(){moduloActividad.off()}),i.promise()},n=function(i){return 0!=a.length&&a[a.length-1].id==i},o=function(){if(0!=a.length){a[a.length-1].nodo.remove(),a.pop()}},t=function(a){var n=i("/soloTexto.html");$.when(n).then(function(i){d("alerta",i,{html:{".mensaje_texto":a}})})},r=function(a){$.when(a).then(function(){t("Hecho!")},function(){t("Error :(")})},e=function(a,i){var n={funciones:{".menu_opc_ingresar":moduloApp.login,".menu_opc_salir":moduloApp.logout,".menu_opc_borrar_cache":moduloApp.borrarCache,".create-ui-toggle2":moduloApp.abrirBarraEdicion,".menuEliminar":moduloEdicion.funcElegirBorrar},html:{}};n=$.extend(n,i),$.each(n.funciones,function(i,n){a.find(i).on("click",function(){o();var a=n();hayValor(a)&&r(a)})});for(var t in n.html)a.find(t).html(n.html[t])},d=function(i,n,o){var t=$(n);$("body").append(t),a.push({id:i,nodo:t}),e(t,o)},c=function(){var a=$.Deferred();if(n("menu"))return o(),a.reject(),a.promise();var t=null;return t=i(moduloApp.esUsuario()?moduloApp.esAdmin()?"/menuInicialAdmin.html":"/menuInicialAnonimo.html":"/menuInicialAnonimo.html"),$.when(t).then(function(i){d("menu",i),a.resolve()}),a.promise()},l=function(){pila.push("menu_pagina"),$(".menu_core").toggleClass("invisible"),$(".menu_pagina").toggleClass("invisible"),window.scrollTo(0,0)},u=function(a,i,n,o){pila.push("formhtml"),console.log("mostrarFormularioEdicion",a,i,n),$(".formhtml").attr("nodo2",a),$(".formhtml").attr("property2",i),$(".formhtml").attr("sufijo",o),$(".formhtml textarea").val(n),$(".formhtml").removeClass("invisible")};return $(document).keyup(function(i){27==i.keyCode&&(0==a.length?c():o())}),{mostrarMenuPagina:l,mostrarFormularioEdicion:u,mostrarMenuBasico:c,mostrarMenuSoloTexto:t}}();if(!hayValor(moduloEdicion))var moduloEdicion=function(){var mapaIds={},activarEdicionOk=!1,activarEdicion=function(){1!=activarEdicionOk&&"undefined"!=typeof Backbone&&(Backbone.sync=function(a,i,n){try{var o=i.toJSON(),t=o["@subject"];i.isNew()&&(t in mapaIds?o["@subject"]=mapaIds[t]:(o["@subject"]="<"+(new Date).getTime()+"_"+Math.floor(10*Math.random()+1)+">",mapaIds[t]=o["@subject"]));var r=o["@subject"],e=o["@type"],d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(e),c=null;d&&(c=d[2]);var l=/(<)(.*)(>)/g,u=l.exec(r);if(null==u)return void n.error("error: no es identificador "+r);var s=u[2],m={};for(var p in o){var d=/(viejs\.org\/ns\/)(.*)(>)/g.exec(p);d&&(m[d[2]]=o[p])}var f={};switch(f.payload=m,f.leng=LENGUAJE,a){case"create":case"update":moduloActividad.on(),$.ajax({type:"PUT",url:"/rest/"+(null===c||void 0===c?"Documento":c)+"/"+s,data:JSON.stringify(f),contentType:"application/json; charset=utf-8"}).done(function(a){n.success(i)}).fail(function(a,i){n.error("error")}).always(function(){moduloActividad.off()})}}catch(a){n.error("error "+a)}},activarEdicionOk=!0)},activarPaginacion=function activarPaginacion(nodo){function activatePageA(actual){var cursor=actual.attr("data-next"),busqueda=JSON.parse(actual.attr("data-q")),template=actual.attr("data-tpl"),target=actual.attr("data-target"),ipage=parseInt(actual.attr("data-page"));busqueda.n||(busqueda.n=100),moduloApp.esAdmin()||actual.html(ipage*busqueda.n+1+" al "+(ipage+1)*busqueda.n),"1"===actual.attr("data-noa")&&(actual.removeAttr("href"),actual.on("click",function(){var docHtml=document.getElementById(template).innerHTML,destino=$(target),postload=destino.attr("data-postload");destino.length>0&&(moduloActividad.on(),$.ajax({type:"PUT",url:"/paginar/",data:JSON.stringify({busqueda:busqueda,cursor:cursor}),contentType:"application/json; charset=utf-8"}).done(function(msg){var datos=msg.datos,sigui=msg.next;destino.empty();for(var i=0;i<datos.length;i++){var dato=datos[i],nuevo=$(docHtml);llenarTemplate(nuevo,dato),destino.append(nuevo)}if(void 0!==sigui&&sigui.length>0){var padrePaginacion=actual.closest(".paginacion");if(0==padrePaginacion.find("[data-next='"+sigui+"']").length){for(var padreLocal=actual.parent(),nombreTAG=padreLocal.prop("tagName"),cambio=!1;padreLocal.get(0)!=padrePaginacion.get(0)&&"BODY"!=nombreTAG;)cambio=!0,actual=padreLocal,padreLocal=padreLocal.parent(),nombreTAG=padreLocal.prop("tagName");var paginaSigui=actual.clone(),paginaSigui2;paginaSigui2=cambio?paginaSigui.find("[data-next]"):paginaSigui,paginaSigui2.attr("data-page",ipage+1),paginaSigui2.attr("data-next",sigui),padrePaginacion.append(paginaSigui),activatePageA(paginaSigui2)}}void 0!==postload&&eval(postload)}).fail(function(a,i){moduloMenus.mostrarMenuSoloTexto("Error paginando")}).always(function(){moduloActividad.off()}))}))}hayValor(nodo)||(nodo=$("body")),nodo.find("a[data-next]").each(function(a,i){activatePageA($(i))})},funcElegirBorrar=function(){var a=$(".btnEliminar");a.length>0?a.remove():$("[about]").each(function(a){var i=$(this),n=i.find(".btnEliminar");if(0==n.length){i.prepend($('<div class="btnEliminar"><div class="btnEliminarX btnEliminar2 manito"></div><div class="btnEliminarX opciones invisible">\t<div class="btnEliminar3"></div>\t<div class="btnEliminar4 manito">Cancelar</div>\t<div class="btnEliminar5 manito">Aceptar</div></div></div>')),n=i.find(".btnEliminar");var o=n.find(".btnEliminar2"),t=n.find(".btnEliminar4"),r=n.find(".btnEliminar5");o.click(function(){var a=$(this);a.addClass("invisible"),a.siblings(".opciones").removeClass("invisible")}),r.click(function(){var a=$(this),i=a.closest("[about]");if(i.length>0){var n=i.attr("about"),o=null;o=i.attr("typeof");var t=(null===o||void 0===o?"":o)+"_"+n;t in mapaIds&&(n=mapaIds[t]),moduloActividad.on(),$.ajax({type:"DELETE",url:"/rest/"+(null===o||void 0===o?"":o)+"/"+n}).done(function(a){i.remove(),$("body").data("Midgard-midgardNotifications").create({body:JSON.stringify(a)}),location.reload()}).fail(function(a,i){$("body").data("Midgard-midgardNotifications").create({body:TRADUCTOR.error_ajax[LENGUAJE]})}).always(function(){moduloActividad.off()})}}),t.click(function(){var a=$(this);a.closest(".opciones").addClass("invisible"),a.closest(".btnEliminar").find(".btnEliminar2").removeClass("invisible")})}}),"menu"===pila[pila.length-1]&&pila.pop()};return activarPaginacion(),{activarPaginacion:activarPaginacion,activarEdicion:activarEdicion,funcElegirBorrar:funcElegirBorrar}}();var pila=[];!function(a){moduloEdicion.activarEdicion()}(jQuery);