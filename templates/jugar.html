{% extends "base.html" %}

{% block encabezado %}
<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
{% endblock %}

{% block content %}

<!-- Modal Apodo -->
<div id="modalNickName" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">¿Cuál es tu apodo?</h4>
      </div>
      <div class="modal-body">
		<div class="form-group">
		  <input type="text" class="form-control" name="apodo">
		</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success">Continuar</button>
      </div>
    </div>
  </div>
</div>

<div id="modalMensaje" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<div class="panel panel-default abc-pregunta">
  <div class="panel-heading abc-titulo">ABC</div>
  <div class="panel-body">
	
  </div>
</div>

{% endblock %}


{% block scripts %}
<script src="/assets/js/comun/bootstrap.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
<script>
	function funcionError(err) {console.log('Error ',err)}
	// Initialize Firebase
	var config = {
	    apiKey: "AIzaSyCWo8e8hTwU-QUhTUBTToIgVbwQBNQlqpM",
	    authDomain: "proyeccion-colombia1.firebaseapp.com",
	    databaseURL: "https://proyeccion-colombia1.firebaseio.com",
	    projectId: "proyeccion-colombia1",
	    storageBucket: "proyeccion-colombia1.appspot.com",
	    messagingSenderId: "569221347334"
	};
	firebase.initializeApp(config);
	var database = firebase.database();
	var ultimaPregunta = database.ref('ultimaPregunta');
	
	var sonidos = {
		'bien': moduloSonido('/assets/sonidos/Mario Grow.mp3'),
		'mal': moduloSonido('/assets/sonidos/Pacman Death.mp3'),
	};
	
	var jugador = (function() {
		
		var datos = {
			apodo: null,
			llave: null,
			llaveCompleta: null,
			db: null,
			datosRemotos: null,
			ultimaPregunta: null,
			jPanelPregunta: $('.abc-pregunta'),
		};
		
		var asignarApodo = function(valor) {
			datos.apodo = valor;
			datos.llave = valor.replace(/[^a-z]+/ig, '_');
			datos.llaveCompleta = '/jugadores/'+datos.llave;
			$('.abc-titulo').html('ABC + <strong>'+valor+'</srong>');
			conectar();
		};
		
		var usuarioEligeRespuesta = function(llaveRes, valorRespuesta, elem, idPregunta) {
			var cuerpoPanel = datos.jPanelPregunta.find('.panel-body');
			//Esconde todas las respuestas
			cuerpoPanel.find('.abc-una-respuesta').hide();
			var updates = {};
			updates[datos.llaveCompleta+'/respuestas/'+idPregunta] = llaveRes;
			var promesa = firebase.database().ref().update(updates);
			promesa.then(function() {
				
			});
			if (valorRespuesta.puntos == 0) {
				sonidos.mal.play();
			} else {
				sonidos.bien.play();
			}
			//Solo se muestra la que la persona escogió
			elem.removeClass('col-xs-6');
			elem.addClass('col-xs-12');
			elem.show();
		};
		
		var regenerarPreguntas = function() {
			var cuerpoPanel = datos.jPanelPregunta.find('.panel-body'); 
			cuerpoPanel.empty();
			
			if (!hayValor(datos.ultimaPregunta)) {return;}
			
			var pregunta = '<div class="col-xs-12">';
			pregunta+='<div class="text-center"><h3>$1</strong></h3>';
			pregunta+='</div>';
			pregunta = pregunta.replace('$1', datos.ultimaPregunta.texto);
			cuerpoPanel.append(pregunta);
			
			var plantila = '<div class="col-xs-6 abc-una-respuesta">';
			plantila += '<div class="panel panel-default">';
			plantila += '<div class="panel-body">';
			
			plantila += '<div class="col-xs-12 pull-left">';
			plantila += '<h4>$1</h4>';
			plantila += '</div>';
			
			plantila += '</div>';
			plantila += '</div>';
			plantila += '</div>';
			
			$.each(datos.ultimaPregunta.respuestas, function(llaveRes, valorRespuesta) {
				var nuevoTexto = plantila;
				nuevoTexto = nuevoTexto.replace('$1', valorRespuesta.texto);
				var nuevo = $(nuevoTexto);
				nuevo.find('.panel-body').css('background-color', valorRespuesta.color);
				nuevo.on('click', function() {
					usuarioEligeRespuesta(llaveRes, valorRespuesta, nuevo, datos.ultimaPregunta.id);
				});
				cuerpoPanel.append(nuevo);
			});
		};
		
		var conectar = function() {
			datos.db = database.ref(datos.llaveCompleta);
			ultimaPregunta.on('value', function(data) {
				datos.ultimaPregunta = data.val();
				regenerarPreguntas();
			});
			datos.db.on("value", function(data) {
				var existente = data.val();
				if (!hayValor(existente)) {
					//Asigna el valor inicial
					datos.remotos = {
						apodo: datos.apodo,
					};
					
					var updates = {};
					updates[datos.llaveCompleta] = datos.remotos;
					var promesa = firebase.database().ref().update(updates);
					
					promesa.then(function() {
						
					});
				} else {
					datos.remotos = existente;
				}
			}, funcionError);
		};
		
		return {
			'asignarApodo': asignarApodo,
		};
	})();
	
	var mostrarModal = function(mensaje) {
		var diferido = $.Deferred();
		var jModalMensaje = $('#modalMensaje');
		jModalMensaje.modal({
			show: true,
		    backdrop: 'static',
		    keyboard: false
			});
		jModalMensaje.find('h4').html(mensaje);
		jModalMensaje.find('button').on('click', function() {
			
		});
		return diferido.promise();
	};
	
	//1. Se debe preguntar el nickname
	var jModalNickName = $('#modalNickName'); 
	jModalNickName.modal({
		show: true,
	    backdrop: 'static',
	    keyboard: false
		});
	jModalNickName.find('button').on('click', function() {
		//Se valida que el nombre no sea vacio
		var apodo = jModalNickName.find('input[name="apodo"]').val();
		if (!hayValor(apodo)) {
			mostrarModal('No puede ser un apodo vacio');
		} else {
			jModalNickName.modal('hide');
			jugador.asignarApodo(apodo);
		}
	});
	
</script>
{% endblock %}